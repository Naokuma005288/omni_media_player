<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Omni Player — Touch</title>

<!-- HLS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

<style>
  :root{
    --bg:#0a0f14;--panel:#0f161f;--ink:#e9eef5;--muted:#8ea0b3;--ring:#223245;--accent:#3b82f6;
    --shadow:0 18px 60px rgba(0,0,0,.35);--soft:14px
  }
  @media (prefers-color-scheme: light){
    :root{--bg:#f6f8fb;--panel:#ffffff;--ink:#0b1016;--muted:#556273;--ring:#dbe3ee}
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic UI",sans-serif;letter-spacing:.01em;-webkit-tap-highlight-color: transparent}
  .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
  header,footer{display:flex;align-items:center;gap:.6rem;padding:10px 12px}
  header{justify-content:space-between}
  .title{display:flex;align-items:center;gap:.6rem}
  .logo{width:24px;height:24px;border-radius:6px;background:linear-gradient(135deg,#7cc1ff,#6c8dff);box-shadow:0 4px 16px rgba(100,150,255,.35)}
  h1{font-size:16px;margin:0}
  .sp{flex:1}
  .chip{padding:.2rem .5rem;border:1px solid var(--ring);border-radius:999px;color:var(--muted)}

  main{position:relative;display:grid;grid-template-rows:1fr auto}
  #stage{position:relative;min-height:50vh;background:#000}
  video,iframe{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000;border:0;touch-action:manipulation}
  #spectrum{position:absolute;left:0;right:0;bottom:0;height:32vh;display:none;z-index:8;mix-blend-mode:screen;opacity:.95;filter:drop-shadow(0 8px 18px rgba(0,0,0,.35));image-rendering:crisp-edges}
  .toast{position:fixed;right:12px;top:12px;display:flex;flex-direction:column;gap:10px;z-index:40;pointer-events:none}
  .t{pointer-events:auto;background:color-mix(in oklab,var(--panel),transparent 6%);border:1px solid var(--ring);padding:.5rem .7rem;border-radius:12px;box-shadow:var(--shadow)}
  .t.warn{border-color:#6a5a1a}.t.err{border-color:#6a1a1a}.t.ok{border-color:#1e6d3d}

  .hud{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;padding:10px;border-top:1px solid var(--ring);background:color-mix(in oklab,var(--panel),transparent 4%)}
  .btn{appearance:none;border:1px solid var(--ring);background:color-mix(in oklab,var(--panel),transparent 6%);color:var(--ink);padding:.55rem .8rem;border-radius:10px}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#182435,#0f1620);color:#e7f1ff;border-color:#243347}
  .row{display:flex;gap:.5rem;align-items:center}
  .input{border:1px solid var(--ring);background:var(--panel);color:var(--ink);padding:.5rem .6rem;border-radius:10px}
  select.input{padding:.45rem .6rem}
  input[type=range]{accent-color:var(--accent)}
  .badge{font-size:12px;color:var(--muted);padding:.1rem .45rem;border:1px solid var(--ring);border-radius:999px}
  .seek{position:absolute;left:10px;right:10px;bottom:12px;height:10px;border-radius:999px;background:rgba(255,255,255,.18)}
  .seek>.prog{height:100%;width:0%;background:rgba(255,255,255,.82);border-radius:999px}
  .seek>.thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:999px;background:#fff}
  .timechip{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.25);padding:.2rem .45rem;border-radius:8px;font-size:12px}
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:18vw;color:#fff;pointer-events:none}
  .overlay .hint{opacity:.0;transition:opacity .2s ease}
  .overlay.show .hint{opacity:.9}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title"><div class="logo"></div><h1>Omni Player — Touch</h1></div>
    <div class="sp"></div>
    <div class="chip">Tap / Swipe / Double-tap</div>
  </header>

  <main>
    <div id="stage">
      <video id="v" playsinline crossorigin="anonymous" muted
             x-webkit-airplay="allow" airplay="allow"></video>
      <canvas id="spectrum"></canvas>
      <div class="timechip" id="time">00:00 / 00:00</div>
      <div class="overlay" id="ovr">
        <div class="hint" id="left">⟲ 10s</div>
        <div class="hint" id="center">⏯</div>
        <div class="hint" id="right">10s ⟳</div>
      </div>
      <div class="seek" id="seek" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="prog" id="seekProg"></div><div class="thumb" id="seekThumb"></div>
      </div>
      <div class="toast" id="toasts"></div>
    </div>

    <div class="hud">
      <div class="row">
        <label class="btn" for="file">ファイル</label><input id="file" type="file" accept="video/*,audio/*,.m3u8,.mp4,.mp3" multiple style="display:none">
        <button class="btn" id="openUrl">URL</button>
        <button class="btn" id="clear">クリア</button>
      </div>
      <div class="row">
        <button class="btn primary" id="play">再生/一時</button>
        <button class="btn" id="back10">⟲10s</button>
        <button class="btn" id="fwd10">10s⟳</button>
      </div>
      <div class="row">
        <label>音量</label><input id="vol" class="input" type="range" min="0" max="1" step="0.01" value="0.9" style="width:120px">
        <label>速度</label><input id="rate" class="input" type="range" min="0.25" max="2" step="0.05" value="1.0" style="width:120px">
      </div>
      <div class="row">
        <label>Spec</label>
        <select id="specMode" class="input">
          <option value="mono">mono</option>
          <option value="pitch">pitch</option>
          <option value="rainbow">rainbow</option>
        </select>
        <label>感度</label><input id="specSens" class="input" type="range" min="0.6" max="1.6" step="0.01" value="1.05" style="width:120px">
      </div>
      <div class="row"><span class="badge">Safari: AirPlay対応（動画右上のシステムUIから）</span></div>
    </div>
  </main>

  <footer>
    <div class="badge">HLS / MP4 / MP3・WAV / ローカル複数ファイル / スペクトラム 3モード</div>
  </footer>
</div>

<script>
/* ===== refs ===== */
const qs=function(s,r){return (r||document).querySelector(s)};
const $={
  v:qs('#v'), stage:qs('#stage'),
  toasts:qs('#toasts'),
  file:qs('#file'), openUrl:qs('#openUrl'), clearBtn:qs('#clear'),
  play:qs('#play'), back10:qs('#back10'), fwd10:qs('#fwd10'),
  vol:qs('#vol'), rate:qs('#rate'),
  seek:qs('#seek'), seekProg:qs('#seekProg'), seekThumb:qs('#seekThumb'), time:qs('#time'),
  specCanvas:qs('#spectrum'), specMode:qs('#specMode'), specSens:qs('#specSens'),
  ovr:qs('#ovr'), oL:qs('#left'), oC:qs('#center'), oR:qs('#right')
};
function toast(msg,type){var d=document.createElement('div');d.className='t '+(type||'ok');d.textContent=msg;$.toasts.appendChild(d);setTimeout(function(){try{d.remove()}catch(e){}},3600)}
function fmtTime(s){ if(!isFinite(s)||s<0) return '0:00'; var m=Math.floor(s/60); var ss=Math.floor(s%60); return m+':'+String(ss).padStart(2,'0') }

/* ===== state ===== */
const state={
  list:[], cur:-1,
  hls:null,
  audioCtx:null, analyser:null, mediaNode:null, outGain:null,
  _unmuteWdg:null,
  // spectrum
  spec:{
    mode: localStorage.getItem('touch.spec.mode') || 'mono',
    sens: parseFloat(localStorage.getItem('touch.spec.sens') || '1.05'),
    bins: 140, data:null, lastDraw:0, maxFps:48, started:false
  },
  _startTime: performance.now(),
  seekRAF: 0,
  tap:{t0:0,x0:0,y0:0,lastTap:0,longId:0}
};

/* ===== Audio unlock ===== */
function forceUnmute(){
  try{
    $.v.muted=false; $.v.removeAttribute('muted');
    if(!Number.isFinite($.v.volume) || $.v.volume===0){ $.v.volume=0.9; $.vol.value=0.9 }
  }catch(e){}
}
function unlockAudioCtx(){
  try{
    if(!state.audioCtx) state.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if(state.audioCtx.state!=='running'){
      state.audioCtx.resume().catch(function(){});
      var src=state.audioCtx.createBufferSource();
      src.buffer=state.audioCtx.createBuffer(1,1,state.audioCtx.sampleRate);
      src.connect(state.audioCtx.destination); src.start(0);
      setTimeout(function(){try{src.stop()}catch(e){}},0);
    }
  }catch(e){}
}
function startUnmuteWatchdog(){
  try{ clearInterval(state._unmuteWdg) }catch(e){}
  var t0=Date.now();
  state._unmuteWdg=setInterval(function(){
    forceUnmute();
    if(Date.now()-t0>4000){ clearInterval(state._unmuteWdg) }
  },140);
}
function ensureAudioGraph(){
  if(!state.audioCtx) state.audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(!state.mediaNode) state.mediaNode=state.audioCtx.createMediaElementSource($.v);
  if(!state.outGain){
    state.outGain=state.audioCtx.createGain(); state.outGain.gain.value=1;
    state.mediaNode.connect(state.outGain); state.outGain.connect(state.audioCtx.destination);
  }
  if(!state.analyser){
    var a=state.audioCtx.createAnalyser();
    a.fftSize=2048; a.minDecibels=-95; a.maxDecibels=-20; a.smoothingTimeConstant=0.82;
    state.analyser=a; state.mediaNode.connect(a);
  }
}

/* ===== Spectrum (lightweight) ===== */
function startSpectrumIfAudioOnly(){
  var isAudioOnly = ($.v.videoWidth===0 && $.v.videoHeight===0);
  if(!isAudioOnly){ $.specCanvas.style.display='none'; state.spec.started=false; return }
  try{
    ensureAudioGraph();
    var dpr=window.devicePixelRatio||1; var rect=$.stage.getBoundingClientRect();
    var Hpx=Math.max(40, Math.floor(rect.height*0.32)), Wpx=Math.max(160, Math.floor(rect.width));
    $.specCanvas.width=Wpx*dpr; $.specCanvas.height=Hpx*dpr; $.specCanvas.style.height=Hpx+'px'; $.specCanvas.style.display='block';
    if(!state.spec.started){ state.spec.started=true; state.spec.lastDraw=0; requestAnimationFrame(drawSpectrum) }
  }catch(e){ $.specCanvas.style.display='none'; state.spec.started=false; }
}
function drawSpectrum(){
  if(!state.spec.started) return;
  var now=performance.now(), minDt=1000/state.spec.maxFps;
  if(now-state.spec.lastDraw<minDt){ requestAnimationFrame(drawSpectrum); return }
  state.spec.lastDraw=now;
  ensureAudioGraph();
  var an=state.analyser, c=$.specCanvas.getContext('2d'), W=$.specCanvas.width, H=$.specCanvas.height;
  if(!state.spec.data || state.spec.data.length!==an.frequencyBinCount) state.spec.data=new Uint8Array(an.frequencyBinCount);
  an.getByteFrequencyData(state.spec.data);
  c.clearRect(0,0,W,H);
  var bins=state.spec.bins, barW=W/bins, pad=Math.max(2,Math.floor(barW*0.12)), inner=Math.max(1,barW-pad);
  var minDb=an.minDecibels, maxDb=an.maxDecibels, range=maxDb-minDb;
  var data=state.spec.data, N=data.length, mode=state.spec.mode, sens=state.spec.sens;
  var t=(now-state._startTime)/1000;

  for(var i=0;i<bins;i++){
    var a=Math.floor(Math.pow(i/bins, 1.8)*N);
    var b=Math.max(a+1, Math.floor(Math.pow((i+1)/bins, 1.8)*N));
    var sum=0,cnt=0; for(var k=a;k<b;k++){ sum+=data[k]; cnt++ }
    var mag=cnt?sum/cnt:0;
    var v=((minDb + (mag/255)*(range)) - minDb)/range; v=Math.max(0,Math.min(1,v*sens)); v=v*v;
    var h=Math.floor(v*(H*0.92));
    var x=i*barW + pad/2; var y=H-h;

    var fill='rgba(255,255,255,.92)';
    if(mode==='pitch'){
      var hue=18 + (260-18)*((a+b)/2/N);
      fill='hsla('+hue+',90%,70%,1)';
    } else if(mode==='rainbow'){
      var hue2=(i/bins)*360 + t*360*0.2;
      fill='hsla('+hue2+',90%,70%,1)';
    }
    c.fillStyle=fill; c.fillRect(x,y,inner,h);
  }
  requestAnimationFrame(drawSpectrum);
}

/* ===== Seek UI ===== */
function mediaDuration(){ return $.v.duration||0 }
function mediaCurrent(){ return $.v.currentTime||0 }
function mediaSeekTo(t){ $.v.currentTime=Math.max(0,Math.min(mediaDuration(),t||0)) }

function updateSeekUI(){
  var dur=mediaDuration(), cur=mediaCurrent();
  if(!(dur>0)) return;
  var p=100*(cur/dur);
  $.seekProg.style.width=p+'%'; $.seekThumb.style.left=p+'%';
  $.seek.setAttribute('aria-valuenow', String(Math.round(p)));
  $.time.textContent = fmtTime(cur)+' / '+fmtTime(dur);
}
function startSeekRAF(){
  cancelAnimationFrame(state.seekRAF);
  var loop=function(){ state.seekRAF=requestAnimationFrame(loop); updateSeekUI() };
  state.seekRAF=requestAnimationFrame(loop);
}
startSeekRAF();

function seekFromClientX(x){
  var rect=$.seek.getBoundingClientRect();
  var ratio=Math.min(1,Math.max(0,(x-rect.left)/rect.width));
  mediaSeekTo((mediaDuration()||0)*ratio);
}
;(function(){
  var dragging=false;
  $.seek.addEventListener('mousedown',function(e){ dragging=true; seekFromClientX(e.clientX); e.preventDefault() });
  window.addEventListener('mousemove',function(e){ if(dragging) seekFromClientX(e.clientX) });
  window.addEventListener('mouseup',function(){ dragging=false });

  $.seek.addEventListener('touchstart',function(e){ dragging=true; seekFromClientX(e.touches[0].clientX) },{passive:false});
  $.seek.addEventListener('touchmove',function(e){ if(dragging) seekFromClientX(e.touches[0].clientX) },{passive:false});
  $.seek.addEventListener('touchend',function(){ dragging=false });
})();

/* ===== playlist ===== */
function addToList(items,replace){
  if(replace){ state.list=[]; state.cur=-1 }
  for(var i=0;i<items.length;i++) state.list.push(items[i]);
  if(state.cur===-1 && state.list.length) loadIndex(0);
}
function loadIndex(i){
  state.cur=i;
  var it=state.list[i]; if(!it) return;
  stopHls();
  $.v.removeAttribute('src'); $.v.load();

  if(it.url){
    loadUrl(it.url);
  } else if(it.file){
    var obj=URL.createObjectURL(it.file);
    $.v.src=obj; $.v.load();
    $.v.addEventListener('loadedmetadata',function(){ try{URL.revokeObjectURL(obj)}catch(e){} },{once:true});
  }
}

function stopHls(){ if(state.hls){ try{state.hls.destroy()}catch(e){} state.hls=null } }
function isHls(u){ return /\.m3u8($|\?)/i.test(u||'') }
function loadUrl(u){
  if(isHls(u)){
    if(window.Hls && Hls.isSupported()){
      var h=new Hls({enableWorker:true,maxBufferLength:30});
      state.hls=h; h.attachMedia($.v); h.on(Hls.Events.MEDIA_ATTACHED,function(){ h.loadSource(u) });
      h.on(Hls.Events.MANIFEST_PARSED,function(){ safePlay('hls:manifest') });
      h.on(Hls.Events.ERROR,function(_,d){ if(d.fatal){ if(d.type===Hls.ErrorTypes.NETWORK_ERROR) h.startLoad(); else if(d.type===Hls.ErrorTypes.MEDIA_ERROR) h.recoverMediaError(); else h.destroy(); } });
    } else if($.v.canPlayType('application/vnd.apple.mpegurl')) {
      $.v.src=u;
    } else {
      toast('HLS未対応','err');
    }
  } else {
    $.v.src=u;
  }
  $.v.load();
}

/* ===== play/pause ===== */
function safePlay(reason){
  forceUnmute(); unlockAudioCtx(); startUnmuteWatchdog();
  try{
    ensureAudioGraph();
    var p=$.v.play();
    if(p && typeof p.then==='function'){ p.then(function(){}).catch(function(err){ if(err && err.name==='AbortError') return; toast('再生失敗: '+(err&&err.name?err.name:'Error'),'warn') }) }
  }catch(e){}
}
function safePause(){ try{$.v.pause()}catch(e){} }

$.play.addEventListener('click',function(){
  forceUnmute(); unlockAudioCtx(); startUnmuteWatchdog();
  if($.v.paused) safePlay('ui'); else safePause();
});
$.back10.addEventListener('click',function(){ mediaSeekTo(mediaCurrent()-10) });
$.fwd10.addEventListener('click',function(){ mediaSeekTo(mediaCurrent()+10) });

$.vol.addEventListener('input',function(){ $.v.volume=+$.vol.value; if($.v.volume>0) forceUnmute(); });
$.rate.addEventListener('input',function(){ $.v.playbackRate=+$.rate.value; });

/* 初回タップで確実に音 */
;(function(){
  var fire=function(){ forceUnmute(); unlockAudioCtx(); startUnmuteWatchdog(); safePlay('gesture'); document.removeEventListener('touchstart',fire); document.removeEventListener('click',fire) };
  document.addEventListener('touchstart',fire,{once:true});
  document.addEventListener('click',fire,{once:true});
})();

/* ===== open/file/dnd ===== */
$.openUrl.addEventListener('click',function(){
  forceUnmute(); unlockAudioCtx(); startUnmuteWatchdog();
  var u=window.prompt('URL を入力（.m3u8 / .mp4 / .mp3 など）:'); if(!u){return}
  var it={ url: u, title: u };
  addToList([it], false);
  loadIndex(state.list.length-1);
});
$.file.addEventListener('change',function(e){
  forceUnmute(); unlockAudioCtx(); startUnmuteWatchdog();
  var files=Array.from(e.target.files||[]); if(!files.length) return;
  var items=files.map(function(f){ return { file: f, title: f.name } });
  addToList(items, true);
});
document.addEventListener('dragover',function(e){e.preventDefault()});
document.addEventListener('drop',function(e){
  e.preventDefault(); forceUnmute(); unlockAudioCtx(); startUnmuteWatchdog();
  var files=Array.from(e.dataTransfer.files||[]); if(!files.length) return;
  var items=files.map(function(f){ return { file: f, title: f.name } });
  addToList(items, state.list.length===0);
});
$.clearBtn.addEventListener('click',function(){
  stopHls(); try{$.v.pause()}catch(e){} $.v.removeAttribute('src'); $.v.load(); state.list=[]; state.cur=-1; toast('クリアしました','ok');
});

/* ===== video events ===== */
$.v.addEventListener('loadedmetadata',function(){ updateSeekUI(); startSpectrumIfAudioOnly(); safePlay('loadedmetadata') });
$.v.addEventListener('canplay',function(){ startSpectrumIfAudioOnly(); });
['play','pause','loadeddata','resize','emptied'].forEach(function(ev){
  $.v.addEventListener(ev,function(){ startSpectrumIfAudioOnly(); updateSeekUI() });
});

/* ===== AirPlay signals (Safari) ===== */
$.v.addEventListener('webkitcurrentplaybacktargetiswirelesschanged',function(e){
  var on=(typeof $.v.webkitCurrentPlaybackTargetIsWireless==='function') ? $.v.webkitCurrentPlaybackTargetIsWireless() : false;
  toast(on?'AirPlay 出力中':'AirPlay 終了', 'ok');
});

/* ===== touch gestures ===== */
;(function(){
  var el=$.stage, lastTap=0, longId=0, isLong=false, startX=0, startT=0;
  el.addEventListener('touchstart',function(ev){
    var t=ev.touches[0]; startX=t.clientX; startT=Date.now(); isLong=false;
    longId=setTimeout(function(){ isLong=true; safePause(); showCenter() },520);
  },{passive:true});
  el.addEventListener('touchend',function(ev){
    clearTimeout(longId);
    var dt=Date.now()-startT;
    if(isLong){ isLong=false; return }
    if(dt<260){
      var now=Date.now();
      if(now-lastTap<300){
        // double tap: decide side
        var x=(ev.changedTouches[0]||{}).clientX||0;
        var w=el.getBoundingClientRect().width;
        if(x<w*0.5){ mediaSeekTo(mediaCurrent()-10); showLeft() } else { mediaSeekTo(mediaCurrent()+10); showRight() }
      }else{
        // single tap: toggle
        if($.v.paused) safePlay('tap'); else safePause();
        showCenter();
      }
      lastTap=now;
    }
  },{passive:true});
  el.addEventListener('touchmove',function(ev){
    if(ev.touches.length!==1) return;
    var dx=ev.touches[0].clientX-startX;
    if(Math.abs(dx)>44){
      var ratio = dx/Math.max(120, el.getBoundingClientRect().width*0.6);
      mediaSeekTo(mediaCurrent()+ratio*(mediaDuration()||0));
      startX=ev.touches[0].clientX;
    }
  },{passive:true});
  function showLeft(){ $.ovr.classList.add('show'); $.oL.style.opacity='1'; $.oC.style.opacity='0.2'; $.oR.style.opacity='0.2'; setTimeout(hideHints,360) }
  function showRight(){ $.ovr.classList.add('show'); $.oL.style.opacity='0.2'; $.oC.style.opacity='0.2'; $.oR.style.opacity='1'; setTimeout(hideHints,360) }
  function showCenter(){ $.ovr.classList.add('show'); $.oL.style.opacity='0.2'; $.oC.style.opacity='1'; $.oR.style.opacity='0.2'; setTimeout(hideHints,360) }
  function hideHints(){ $.ovr.classList.remove('show') }
})();

/* ===== spectrum controls ===== */
(function(){
  $.specMode.value = state.spec.mode;
  $.specSens.value = String(state.spec.sens);
  $.specMode.addEventListener('change',function(){
    state.spec.mode = $.specMode.value;
    try{localStorage.setItem('touch.spec.mode', state.spec.mode)}catch(e){}
  });
  $.specSens.addEventListener('input',function(){
    var v=parseFloat($.specSens.value)||1.05;
    state.spec.sens=v; try{localStorage.setItem('touch.spec.sens', String(v))}catch(e){}
  });
})();

/* ===== init ===== */
(function init(){
  var vol=0.9; var rate=1.0;
  try{
    var sv=localStorage.getItem('touch.vol'); if(sv!=null) vol=parseFloat(sv)||0.9;
    var sr=localStorage.getItem('touch.rate'); if(sr!=null) rate=parseFloat(sr)||1.0;
  }catch(e){}
  $.v.volume=vol; $.vol.value=vol;
  $.v.playbackRate=rate; $.rate.value=rate;
  $.vol.addEventListener('change',function(){ try{localStorage.setItem('touch.vol',String($.vol.value))}catch(e){} });
  $.rate.addEventListener('change',function(){ try{localStorage.setItem('touch.rate',String($.rate.value))}catch(e){} });
})();
</script>
</body>
</html>
