<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Omni Player PC — Fullscreen + Overlay UI</title>

<!-- === FX/Animations === -->
<link rel="stylesheet" href="css/fx.css" />
<script defer src="js/anims.js"></script>

<!-- === Spectrum / Crossfade === -->
<script defer src="js/spectrum.js"></script>
<script defer src="js/crossfade.js"></script>

<!-- HLS（m3u8用。ローカルmp4/mp3は不要） -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

<style>
  :root{
    --bg:#0b0e12; --panel:#11161d; --panel2:#0d1218; --text:#e8edf2; --muted:#9fb0c4;
    --accent:#2d7ef7; --ok:#2ecc71; --danger:#e45656; --shadow:rgba(0,0,0,.38);
    --radius:14px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic UI",sans-serif;letter-spacing:.01em; overflow:hidden}

  /* ===== Shell / Player ===== */
  .player-shell{position:fixed; inset:0; display:flex; background:#000}
  .op-player-wrap{position:relative; flex:1; overflow:hidden; background:#000}

  video{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; z-index:1}

  /* ===== Control Bar (bottom overlay) ===== */
  .control-bar{
    position:absolute; left:0; right:0; bottom:0; z-index:10; /* ← 重要: ボタンが最前面 */
    padding:.55rem .8rem .7rem;
    background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(8,10,14,.55) 30%, rgba(8,10,14,.72) 100%);
    backdrop-filter: blur(8px) saturate(1.15);
    display:grid; gap:.6rem; grid-template-rows:auto auto; user-select:none;
  }
  .ctrl-top, .ctrl-bottom{display:flex; gap:.5rem; align-items:center}
  .ctrl-top{justify-content:space-between}
  .left-group, .right-group{display:flex; gap:.35rem; align-items:center}

  .btn{
    height:34px; padding:.36rem .7rem; border-radius:10px; border:1px solid rgba(255,255,255,.15);
    background:linear-gradient(180deg, #121821, #0d1218); color:#fff; cursor:pointer;
    display:inline-flex; gap:.45rem; align-items:center; transition:filter .15s ease, transform .06s ease;
  }
  .btn:hover{filter:brightness(1.08)}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent}
  .btn.ok{border-color:#1d6e3b; background:linear-gradient(180deg,#102218,#0b1a13)}
  .icon{font-size:13px; opacity:.92}

  .time{min-width:80px; text-align:center; color:var(--muted)}
  .spacer{flex:1}

  .seek{
    flex:1; display:flex; align-items:center; gap:.6rem;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
    border-radius:999px; padding:.35rem .6rem;
  }
  .seek input[type=range]{width:100%; accent-color:var(--accent)}
  .sliders{display:flex; gap:.8rem; align-items:center}
  .sliders .lab{font-size:12px; color:var(--muted)}

  /* ===== Settings / Tips panels ===== */
  .panel-scrim{
    position:absolute; inset:0; z-index:20; display:none;
    background:rgba(0,0,0,.35); backdrop-filter:blur(2px);
  }
  .panel-scrim.show{display:block}
  .panel{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(960px,92vw); max-height:min(78vh,780px); overflow:auto;
    background:color-mix(in oklab, var(--panel2), transparent 6%);
    border:1px solid rgba(255,255,255,.15); border-radius:16px;
    box-shadow:0 18px 80px var(--shadow);
    backdrop-filter: blur(16px) saturate(1.2);
    padding:1rem 1rem 1.1rem; color:var(--text);
  }
  .panel h3{margin:.2rem 0 .8rem}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:.8rem}
  .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:.7rem}
  .row{display:flex; gap:.5rem; align-items:center; margin:.4rem 0}
  .row input[type=text], .row input[type=url], .row input[type=number], .row select{
    flex:1; min-width:0; background:#0a0f15; color:#fff; border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:.5rem .6rem;
  }
  .subtle{color:var(--muted); font-size:12px}
  .kbd-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:.5rem}
  .kbd{background:#0a0f15; border:1px solid rgba(255,255,255,.14); border-radius:10px; padding:.5rem}
  .kbd kbd{background:#10161f; border:1px solid #273346; border-radius:6px; padding:.12rem .4rem; margin-right:.3rem}

  .badge{font-size:12px; color:var(--muted); border:1px solid rgba(255,255,255,.14); padding:.16rem .5rem; border-radius:999px}

  @media (max-width: 640px){
    .control-bar{padding:.5rem .6rem .65rem}
    .sliders{display:none}
    .time{min-width:64px}
  }
</style>
</head>
<body>
  <div class="player-shell">
    <div class="op-player-wrap" id="wrap">
      <!-- muted は付けない -->
      <video id="v" playsinline crossorigin="anonymous" preload="metadata"></video>

      <!-- ===== Bottom Control Bar ===== -->
      <div class="control-bar" id="ctrl">
        <div class="ctrl-top">
          <div class="left-group">
            <button class="btn" id="btnPlay"><span class="icon" id="playIcon">▶︎</span><span>再生/一時停止</span></button>
            <button class="btn ghost" id="btnBack">⟲ 10s</button>
            <button class="btn ghost" id="btnFwd">⟳ 10s</button>
            <span class="badge" id="badgeState">IDLE</span>
          </div>
          <div class="right-group">
            <button class="btn ghost" id="btnTips">Tips</button>
            <button class="btn ghost" id="btnSettings">設定</button>
            <button class="btn ghost" id="btnPip">PiP</button>
            <button class="btn ghost" id="btnFs">⛶</button>
          </div>
        </div>

        <div class="ctrl-bottom">
          <div class="seek">
            <span class="time" id="cur">0:00</span>
            <input id="seek" type="range" min="0" max="1000" step="1" value="0" />
            <span class="time" id="dur">0:00</span>
          </div>
          <div class="spacer"></div>
          <div class="sliders">
            <span class="lab">音量</span><input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" />
            <span class="lab">速度</span><input id="rate" type="range" min="0.25" max="2" step="0.05" value="1" />
          </div>
        </div>
      </div>

      <!-- ===== Settings Panel ===== -->
      <div class="panel-scrim" id="settingsScrim">
        <div class="panel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
          <h3 id="settingsTitle">設定</h3>
          <div class="grid">
            <div class="card">
              <div class="row"><strong>ソース</strong></div>
              <div class="row">
                <input id="url" type="url" placeholder="https://（.m3u8 / .mp4 / .mp3 ...）" />
                <button class="btn ok" id="openUrl">開く</button>
              </div>
              <div class="row">
                <input id="file" type="file" multiple accept="video/*,audio/*,.m3u8,.mp3,.mp4" />
              </div>
              <div class="subtle">m3u8はHLS.js、ローカルは file:// OK（CORS制限のあるURLは不可）</div>
            </div>

            <div class="card">
              <div class="row"><strong>字幕</strong></div>
              <div class="row">
                <input id="subFile" type="file" accept=".srt,.vtt" />
                <button class="btn ghost" id="btnSubClear">解除</button>
              </div>
              <div class="row"><label>サイズ(px)</label><input id="subSize" type="number" min="12" max="52" step="1" value="28" /></div>
              <div class="row"><label>縁(px)</label><input id="subOutline" type="number" min="0" max="8" step="1" value="3" /></div>
              <div class="row"><label>下マージン(px)</label><input id="subMargin" type="number" min="0" max="300" step="5" value="30" /></div>
              <div class="row"><label>オフセット(ms)</label><input id="subOffset" type="number" step="50" value="0" /></div>
              <div class="subtle">ASSはhttps運用で</div>
            </div>

            <div class="card">
              <div class="row"><strong>スペクトラム</strong></div>
              <div class="row">
                <label>モード</label>
                <select id="specMode">
                  <option value="bars">Bars</option>
                  <option value="circular">Circular</option>
                </select>
              </div>
              <div class="row">
                <label>動画に重ねる</label>
                <select id="specOverlay">
                  <option value="on">ON</option>
                  <option value="off">OFF</option>
                </select>
              </div>
              <div class="row"><label>感度</label><input id="specSens" type="range" min="0.6" max="1.6" step="0.01" value="1.02" /></div>
              <div class="row"><label>バー本数</label><input id="specBins" type="range" min="60" max="220" step="1" value="160" /></div>
            </div>

            <div class="card">
              <div class="row"><strong>クロスフェード & ギャップレス</strong></div>
              <div class="row">
                <label>有効</label>
                <select id="xfEnable"><option value="on">ON</option><option value="off">OFF</option></select>
              </div>
              <div class="row"><label>フェード秒</label><input id="xfSec" type="number" min="0.2" max="6" step="0.1" value="1.6" /></div>
            </div>

            <div class="card">
              <div class="row"><strong>アニメーションFX</strong></div>
              <div class="row">
                <label>プリセット</label>
                <select id="fxPreset">
                  <option value="minimal">Minimal</option>
                  <option value="glow">Glow</option>
                  <option value="neon">Neon</option>
                  <option value="clean">Clean</option>
                </select>
              </div>
              <div class="subtle">重い時は Clean / Minimal を</div>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end; margin-top:.8rem">
            <button class="btn ghost" id="btnCloseSettings">閉じる（Esc）</button>
          </div>
        </div>
      </div>

      <!-- ===== Tips Panel ===== -->
      <div class="panel-scrim" id="tipsScrim">
        <div class="panel" role="dialog" aria-modal="true" aria-labelledby="tipsTitle">
          <h3 id="tipsTitle">Tips / ショートカット</h3>
          <div class="kbd-grid">
            <div class="kbd"><p><kbd>Space</kbd> 再生/一時停止</p><p><kbd>←</kbd>/<kbd>→</kbd> 10秒移動</p></div>
            <div class="kbd"><p><kbd>0–9</kbd> 位置ジャンプ(%)</p><p><kbd>[</kbd>/<kbd>]</kbd> 速度 ±0.05</p></div>
            <div class="kbd"><p><kbd>f</kbd> フルスクリーン</p><p><kbd>p</kbd> PiP</p></div>
            <div class="kbd"><p><kbd>Esc</kbd> パネルを閉じる</p></div>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:.8rem">
            <button class="btn ghost" id="btnCloseTips">閉じる（Esc）</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  const $=sel=>document.querySelector(sel);
  const v = $('#v'), wrap = $('#wrap');

  // FXを初期化（背景レイヤを注入）
  if (window.OPFX) {
    OPFX.init({ wrap });
    OPFX.setPreset('minimal');
  }

  // ===== Spectrum helper: 初期化/切替時に常に呼ぶ =====
  function attachSpectrumNow(bottom = 18){
    if (!window.OPSpectrum) return;
    try{
      OPSpectrum.offsetBottom = bottom;   // 画面のさらに下に寄せる
      OPSpectrum.overlayOnVideo = true;   // 動画に重ねる
      OPSpectrum.attach(v, wrap);         // 何度呼んでもOK（内部で既存ノード再利用）
    }catch(e){}
  }

  const S = { dragging:false, duration:0, subOffset:0, subTrack:null, _hls:null };

  const fmt = (t)=>{
    if(!isFinite(t)||t<0) return '0:00';
    const s = Math.floor(t%60).toString().padStart(2,'0');
    const m = Math.floor(t/60);
    if(m>=60){ const h=Math.floor(m/60); const mm=(m%60).toString().padStart(2,'0'); return `${h}:${mm}:${s}` }
    return `${m}:${s}`;
  };
  const updateTimes = ()=>{
    $('#cur').textContent = fmt(v.currentTime||0);
    $('#dur').textContent = isFinite(v.duration)? fmt(v.duration) : '0:00';
    if(!S.dragging && isFinite(v.duration)){
      const p = Math.max(0, Math.min(1, (v.currentTime||0)/(v.duration||1)));
      $('#seek').value = Math.round(p*1000);
    }
  };
  const setBadge = (txt)=> $('#badgeState').textContent = txt;

  // Playback wiring
  $('#btnPlay').onclick = ()=> { if(v.paused){ v.play().catch(()=>{}); } else v.pause(); };
  v.addEventListener('play', ()=>{ $('#playIcon').textContent='⏸'; setBadge('PLAY') });
  v.addEventListener('pause', ()=>{ $('#playIcon').textContent='▶︎'; setBadge('PAUSE') });
  v.addEventListener('loadedmetadata', ()=>{ S.duration=v.duration||0; updateTimes(); setBadge('READY') });
  v.addEventListener('timeupdate', updateTimes);
  v.addEventListener('ended', ()=> setBadge('ENDED'));

  $('#btnBack').onclick = ()=> v.currentTime = Math.max(0,(v.currentTime||0)-10);
  $('#btnFwd').onclick  = ()=> v.currentTime = Math.min((v.duration||0),(v.currentTime||0)+10);

  const seek = $('#seek');
  seek.addEventListener('input', ()=> {
    const p = +seek.value/1000;
    $('#cur').textContent = fmt((v.duration||0)*p);
  });
  seek.addEventListener('change', ()=>{
    const p = +seek.value/1000;
    v.currentTime = (v.duration||0)*p;
    S.dragging=false;
  });
  seek.addEventListener('mousedown', ()=> S.dragging=true);
  seek.addEventListener('mouseup',   ()=> S.dragging=false);

  $('#vol').addEventListener('input', e=> v.volume=+e.target.value);
  $('#rate').addEventListener('input', e=> v.playbackRate=+e.target.value);

  $('#btnPip').onclick = async ()=>{
    try{
      if(document.pictureInPictureElement) await document.exitPictureInPicture();
      else await v.requestPictureInPicture();
    }catch(e){ setBadge('PiP NG') }
  };
  $('#btnFs').onclick = ()=> { if(!document.fullscreenElement){ wrap.requestFullscreen?.() } else { document.exitFullscreen?.() } };

  // HLS / URL / File
  function isHls(u){ return /\.m3u8($|\?)/i.test(u) }
  function stopHls(){ if(S._hls){ try{ S._hls.destroy() }catch(e){} S._hls=null } }

  async function openUrl(u){
    if(!u) return;
    stopHls();
    v.removeAttribute('src'); v.load();

    if(isHls(u) && window.Hls && Hls.isSupported()){
      S._hls = new Hls({enableWorker:false}); // file:// 安定性優先
      S._hls.attachMedia(v);
      S._hls.on(Hls.Events.MEDIA_ATTACHED, ()=> S._hls.loadSource(u));
    }else{
      v.src=u;
    }
    // 初期スペクトラム張り直し
    attachSpectrumNow();
    v.play().catch(()=>{});
  }

  $('#openUrl').onclick = ()=> openUrl( $('#url').value.trim() );

  $('#file').addEventListener('change', e=>{
    const f = e.target.files?.[0];
    if(!f) return;
    stopHls();
    const url = URL.createObjectURL(f);
    v.src = url;
    attachSpectrumNow(); // ファイル選択も再アタッチ
    v.play().catch(()=>{});
  });

  // Subtitles
  function srtToVtt(srt){
    const vtt='WEBVTT\n\n'+String(srt).replace(/\r/g,'')
      .replace(/^(\d+)\s*$/gm,'')
      .replace(/(\d\d:\d\d:\d\d),(\d{3})/g,'$1.$2');
    return new Blob([vtt],{type:'text/vtt'});
  }
  function applySubStyle(){
    const size = +$('#subSize').value||28;
    const outline = +$('#subOutline').value||3;
    const margin = +$('#subMargin').value||30;
    let style = document.getElementById('sub-style');
    if(!style){ style=document.createElement('style'); style.id='sub-style'; document.head.appendChild(style); }
    style.textContent = `
      video::cue{font-family:"Noto Sans JP",system-ui;font-size:${size}px;line-height:1.2;color:#fff;
        text-shadow:0 0 ${outline}px rgba(0,0,0,.9);}
      video::-webkit-media-text-track-container{ transform:translateY(-${margin}px); }
    `;
  }
  function unloadTracks(){ Array.from(v.querySelectorAll('track')).forEach(t=>t.remove()); S.subTrack=null }
  $('#subFile').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    unloadTracks();
    let blob;
    if(f.name.endsWith('.vtt')) blob = new Blob([await f.text()],{type:'text/vtt'});
    else blob = srtToVtt(await f.text());
    const url = URL.createObjectURL(blob);
    const tr = document.createElement('track');
    tr.kind='subtitles'; tr.label='ext'; tr.srclang='ja'; tr.default=true; tr.src=url;
    v.appendChild(tr);
    tr.addEventListener('load', ()=>{ tr.mode='showing'; S.subTrack=tr.track; });
  });
  $('#btnSubClear').onclick = ()=> unloadTracks();
  ['#subSize','#subOutline','#subMargin'].forEach(sel=> $(sel).addEventListener('input', applySubStyle));
  applySubStyle();
  $('#subOffset').addEventListener('change', e=> S.subOffset = (+e.target.value)||0 );

  // Panels
  const showPanel=(scrim)=> scrim.classList.add('show');
  const hidePanel=(scrim)=> scrim.classList.remove('show');
  $('#btnSettings').onclick = ()=> showPanel($('#settingsScrim'));
  $('#btnTips').onclick     = ()=> showPanel($('#tipsScrim'));
  $('#btnCloseSettings').onclick = ()=> hidePanel($('#settingsScrim'));
  $('#btnCloseTips').onclick     = ()=> hidePanel($('#tipsScrim'));
  $('#settingsScrim').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) hidePanel(e.currentTarget) });
  $('#tipsScrim').addEventListener('click',     (e)=>{ if(e.target===e.currentTarget) hidePanel(e.currentTarget) });
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ hidePanel($('#settingsScrim')); hidePanel($('#tipsScrim')) }
    if(e.key===' '){ e.preventDefault(); $('#btnPlay').click() }
    if(e.key==='ArrowLeft') $('#btnBack').click();
    if(e.key==='ArrowRight') $('#btnFwd').click();
    if(e.key==='['){ const r=$('#rate'); r.value=(+r.value-0.05).toFixed(2); v.playbackRate=+r.value }
    if(e.key===']'){ const r=$('#rate'); r.value=(+r.value+0.05).toFixed(2); v.playbackRate=+r.value }
    if(e.key==='f') $('#btnFs').click();
    if(e.key==='p') $('#btnPip').click();
    if(/^[0-9]$/.test(e.key) && isFinite(v.duration)){ v.currentTime = v.duration * (+e.key/10) }
  });

  // Spectrum UI
  const bindSpectrumUI = ()=>{
    if(!window.OPSpectrum) return;
    $('#specMode').addEventListener('change', e=>{
      OPSpectrum.setMode(e.target.value);
      OPSpectrum.attach(v, wrap);
    });
    $('#specOverlay').addEventListener('change', e=>{
      OPSpectrum.overlayOnVideo = (e.target.value==='on');
      OPSpectrum.attach(v, wrap);
    });
    $('#specSens').addEventListener('input', e=> OPSpectrum.sens = +e.target.value);
    $('#specBins').addEventListener('input', e=>{
      OPSpectrum.bins = +e.target.value;
      OPSpectrum.attach(v, wrap);
    });
    // 初期一回
    OPSpectrum.attach(v, wrap);
  };

  // Crossfade UI（OPCrossfade / OPXFade 互換）
  const bindXFadeUI = ()=>{
    const XF = window.OPCrossfade || window.OPXFade;
    if(!XF) return;
    const state = { enabled: ($('#xfEnable').value==='on'), sec: +$('#xfSec').value||1.6 };
    $('#xfEnable').addEventListener('change', e=> state.enabled = (e.target.value==='on'));
    $('#xfSec').addEventListener('change',   e=> state.sec     = (+e.target.value||1.6));
    // 実切替時に利用例:
    // if(state.enabled){ XF.start({ current: v, next: nextEl, duration: state.sec*1000 }); }
  };

  // FX UI
  const bindFxUI = ()=>{
    if(!window.OPFX) return;
    $('#fxPreset').addEventListener('change', e=> OPFX.setPreset(e.target.value));
  };

  window.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(()=>{ bindSpectrumUI(); bindXFadeUI(); bindFxUI(); }, 0);
    // 初期スペクトラムを確実に展開（キャンバス生成＆下寄せ）
    attachSpectrumNow(18);
  });

  try{ v.volume = +localStorage.getItem('pc.vol') || 0.9 }catch(e){}
  document.getElementById('vol').value = v.volume;
  document.getElementById('rate').value = v.playbackRate;
  document.getElementById('vol').addEventListener('change', ()=> localStorage.setItem('pc.vol', v.volume));
})();
</script>

<!-- 初回アンミュート/AudioContext再開（クリック/キー入力で一度だけ） -->
<script defer src="js/audio-unlock.js"></script>
</body>
</html>
