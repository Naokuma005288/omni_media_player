<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OmniMedia â€“ Landing v8.3</title>
<meta name="theme-color" content="#0b0e12" id="themeColorMeta">

<script>
(function(){
  const ok = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if(ok){ const l=document.createElement('link'); l.rel='manifest'; l.href='./manifest.json'; document.head.appendChild(l); }
})();
</script>

<style>
:root{
  --bg:#0b0e12;--panel:#0f141b;--panel2:#0b1118;--text:#e8edf3;--muted:#a6b0bb;
  --accent:#74b3ff;--ring:#243246;--shadow:0 20px 60px rgba(0,0,0,.35);
  --ok:#2ecc71;--warn:#c7a300; --err:#ff5c5c; --ease:cubic-bezier(.22,.61,.36,1);
  --spot-x:50%; --spot-y:50%;
  --card-pad:18px;
}
[data-theme="light"]{
  --bg:#f4f7fb;--panel:#fff;--panel2:#f3f6fb;--text:#0c1116;--muted:#5b6773;
  --accent:#3478ff;--ring:#dbe4f0;--shadow:0 14px 40px rgba(15,30,60,.08);
}
html.reduce *{animation:none!important;transition:none!important}

html,body{height:100%;margin:0;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic UI",sans-serif;background:var(--bg);color:var(--text);overflow:auto}
.wrap{position:relative;z-index:5;display:grid;grid-template-rows:auto auto 1fr auto;min-height:100vh}
header,footer{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;align-items:center;gap:.6rem}
.logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#6c8dff);box-shadow:0 4px 20px rgba(100,150,255,.35)}
h1{font-size:16px;margin:0}
header h1.shimmer{
  background:linear-gradient(90deg,#fff, color-mix(in oklab, var(--accent) 70%, #fff) 40%, #fff 80%);
  -webkit-background-clip:text;background-clip:text;color:transparent;background-size:220% 100%;
  animation:titleShimmer 8s linear infinite;
}
@keyframes titleShimmer{0%{background-position:0% 0}100%{background-position:-220% 0}}
.version{font-size:12px;color:var(--muted);margin-left:8px}
main{display:block;padding:0 0 40px}
footer{border-top:1px solid var(--ring);font-size:12px;color:var(--muted);animation:footerIn .9s ease .2s both}
@keyframes footerIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}

.toolbar{display:flex;gap:.5rem;align-items:center;padding:0 14px 8px}
#filter{width:320px;max-width:60vw;background:var(--panel2);border:1px solid var(--ring);color:var(--text);border-radius:10px;padding:.55rem .7rem;outline:0}

/* Small utility UI */
.badge{margin-left:8px;padding:2px 6px;border-radius:6px;background:var(--panel2);border:1px solid var(--ring);color:var(--muted)}
.badge.off{background:#4a5562;color:#fff}

/* FPS + Toast + Ctx */
#fps{position:fixed;left:8px;bottom:8px;background:var(--panel);border:1px solid var(--ring);border-radius:8px;padding:4px 8px;color:var(--muted);opacity:.9;display:none;z-index:60}
#fps.show{display:block}
#toasts{position:fixed;right:12px;bottom:12px;display:grid;gap:8px;z-index:70}
#toasts .toast{background:var(--panel);border:1px solid var(--ring);border-left:4px solid var(--accent);border-radius:10px;padding:8px 12px;box-shadow:var(--shadow);color:var(--text)}
#toasts .toast .act{margin-left:8px;text-decoration:underline;cursor:pointer;color:var(--accent)}
#ctx{position:fixed;z-index:80;background:var(--panel);border:1px solid var(--ring);border-radius:10px;box-shadow:var(--shadow);display:none;min-width:160px;overflow:hidden}
#ctx .row{padding:8px 12px;cursor:pointer;color:var(--text)}
#ctx .row:hover{background:var(--panel2)}

/* BG layers */
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;background:
  radial-gradient(1200px 800px at 20% 30%,rgba(80,130,255,.10),transparent 60%),
  radial-gradient(900px 700px at 75% 75%,rgba(60,200,255,.10),transparent 60%),
  linear-gradient(180deg,rgba(0,0,0,.15),transparent 40%,rgba(0,0,0,.2));animation:bgHue 28s ease-in-out infinite alternate;filter:blur(2px)}
@keyframes bgHue{0%{filter:hue-rotate(0deg) brightness(.95)}100%{filter:hue-rotate(150deg) brightness(1.08)}}
.aurora{position:fixed;inset:-10% -10% -5% -10%;z-index:1;pointer-events:none;background:
  conic-gradient(from 0deg at 60% 40%, color-mix(in oklab,var(--accent) 40%, transparent), rgba(0,255,170,.08), rgba(255,120,200,.08), color-mix(in oklab,var(--accent) 40%, transparent));
  mask: radial-gradient(60% 50% at 50% 40%, #000 55%, transparent 70%) radial-gradient(40% 35% at 60% 80%, #000 45%, transparent 70%);
  animation:auroraFlow 22s linear infinite}
@keyframes auroraFlow{to{transform:translate3d(0,-3%,0) rotate(360deg)}}
.vignette{position:fixed;inset:0;z-index:2;pointer-events:none;background:radial-gradient(60% 55% at 50% 45%, transparent 60%, rgba(0,0,0,.55) 100%);animation:vigBreath 8s ease-in-out infinite}
@keyframes vigBreath{0%,100%{opacity:.95}50%{opacity:.82}}
.nebula{position:fixed;inset:-20% -20% -10% -20%;z-index:1;pointer-events:none;opacity:.25;filter:blur(24px) saturate(1.1);mix-blend-mode:screen;background:
  radial-gradient(40% 30% at 20% 40%, color-mix(in oklab,var(--accent) 26%, #fff) , transparent 60%),
  radial-gradient(35% 28% at 70% 60%, rgba(255,140,220,.28), transparent 60%),
  radial-gradient(50% 40% at 50% 20%, rgba(0,255,200,.22), transparent 60%);
  animation:nebulaDrift 40s ease-in-out infinite alternate}
@keyframes nebulaDrift{0%{transform:translate3d(-1%,1%,0) scale(1)}100%{transform:translate3d(1%,-1%,0) scale(1.04)}}
.nebula.flare{animation:nebulaFlare 1.2s ease}
@keyframes nebulaFlare{0%{filter:blur(24px) saturate(1.1)}50%{filter:blur(28px) saturate(1.35)}100%{filter:blur(24px) saturate(1.1)}}

.beams{position:fixed;inset:-20% -20% -10% -20%;z-index:1;pointer-events:none;opacity:0;filter:blur(18px) saturate(1.1);mix-blend-mode:screen;background:
  conic-gradient(from 120deg at 20% -10%, rgba(255,240,180,.18), transparent 40%),
  conic-gradient(from 210deg at 80% -10%, rgba(180,220,255,.16), transparent 40%),
  conic-gradient(from 160deg at 50% -10%, rgba(255,180,220,.16), transparent 45%)}
.beams.show{opacity:1;animation:beamsMove 20s linear infinite}
@keyframes beamsMove{0%{transform:translateY(2%) rotate(0deg)}50%{transform:translateY(-1%) rotate(1deg)}100%{transform:translateY(2%) rotate(0deg)}}

.stars2{position:fixed;inset:0;z-index:1;pointer-events:none;opacity:0;background:
  radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.9), transparent 60%),
  radial-gradient(1px 1px at 25% 70%, rgba(255,255,255,.8), transparent 60%),
  radial-gradient(1px 1px at 40% 40%, rgba(255,255,255,.85), transparent 60%),
  radial-gradient(1px 1px at 60% 25%, rgba(255,255,255,.85), transparent 60%),
  radial-gradient(1px 1px at 75% 60%, rgba(255,255,255,.9), transparent 60%),
  radial-gradient(1px 1px at 85% 35%, rgba(255,255,255,.85), transparent 60%),
  radial-gradient(1px 1px at 55% 80%, rgba(255,255,255,.85), transparent 60%)}
.stars2.show{opacity:.28;animation:starsTwinkle 9s ease-in-out infinite alternate}
@keyframes starsTwinkle{0%{filter:brightness(.9)}50%{filter:brightness(1.2)}100%{filter:brightness(.9)}}

.warp{position:fixed;inset:0;z-index:1;pointer-events:none;opacity:0;background:
  repeating-linear-gradient(120deg, color-mix(in oklab,var(--accent) 60%, #fff) .13, color-mix(in oklab,var(--accent) 60%, #fff) 2px, transparent 2px, transparent 26px)}
.warp.show{opacity:.35;animation:warpPan 16s linear infinite}
@keyframes warpPan{0%{background-position:0 0}100%{background-position:600px -320px}}

/* Scan */
.scan{position:fixed;inset:0;z-index:3;pointer-events:none;opacity:0;background:
  repeating-linear-gradient(0deg, rgba(255,255,255,.05) 0, rgba(255,255,255,.05) 1px, transparent 1px, transparent 3px)}
.scan.show{opacity:.14;animation:scanFlicker 10s ease-in-out infinite alternate}
@keyframes scanFlicker{0%,100%{filter:brightness(1)}50%{filter:brightness(1.15)}}

/* Bokeh & cursor */
.bokeh{position:absolute;width:240px;height:240px;border-radius:50%;pointer-events:none;mix-blend-mode:screen;opacity:.22;background:radial-gradient(circle, color-mix(in oklab,var(--accent) 80%, #fff) 0%, transparent 65%);animation:bokehMove 24s ease-in-out infinite}
.bokeh:nth-child(1){top:12%;left:14%;animation-delay:-3s}
.bokeh:nth-child(2){top:58%;left:68%;animation-delay:-7s}
.bokeh:nth-child(3){top:78%;left:24%;animation-delay:-11s}
.bokeh:nth-child(4){top:82%;left:86%;animation-delay:-5s}
@keyframes bokehMove{0%{transform:translate3d(0,0,0) scale(1)}50%{transform:translate3d(80px,-60px,0) scale(1.18)}100%{transform:translate3d(0,0,0) scale(1)}}
.cursor{position:fixed;width:340px;height:340px;border-radius:50%;pointer-events:none;z-index:4;opacity:.5;background:radial-gradient(circle, color-mix(in oklab,var(--accent) 65%, #fff) 0%, transparent 70%);mix-blend-mode:overlay;transform:translate(-170px,-170px);transition:transform .25s ease-out, opacity .4s}

/* Trail */
.trail{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;z-index:4;background:radial-gradient(circle, rgba(255,255,255,.9) 0, rgba(255,255,255,0) 70%);mix-blend-mode:screen;animation:trailFade .6s ease-out both}
@keyframes trailFade{from{transform:translate(-50%,-50%) scale(.6);opacity:.9}to{transform:translate(-50%,-50%) scale(2.2);opacity:0}}

/* Sections */
.section{position:relative;padding:12px 22px 28px;scroll-margin-top:64px}
.sec-title{width:min(980px,92vw);margin:18px auto 8px;display:flex;align-items:center;gap:10px}
.sec-title h2{margin:0;font-size:18px}
.sec-title .hint{font-size:12px;color:var(--muted)}
.scroll-cue{position:relative;display:grid;place-items:center;margin:10px 0 2px}
.scroll-cue .chev{width:18px;height:18px;border-bottom:2px solid color-mix(in oklab,var(--accent),#fff 35%);border-right:2px solid color-mix(in oklab,var(--accent),#fff 35%);transform:rotate(45deg);animation:cue 1.6s ease-in-out infinite}
@keyframes cue{0%,100%{opacity:.5;transform:translateY(0) rotate(45deg)}50%{opacity:1;transform:translateY(6px) rotate(45deg)}}

/* Grid & cards */
.grid{width:min(980px,92vw);display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;perspective:1200px;margin:0 auto}
.card{position:relative;background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:var(--card-pad);box-shadow:var(--shadow);opacity:0;transform:translateY(20px) rotateX(5deg) rotateY(-5deg) scale(.98);transition:transform .28s var(--ease),box-shadow .28s var(--ease),filter .28s, opacity .5s;transform-style:preserve-3d;will-change:transform;background-image:radial-gradient(200px 200px at var(--spot-x) var(--spot-y), color-mix(in oklab,var(--accent) 40%, transparent), transparent 70%);background-blend-mode:screen;overflow:hidden}
.loaded .card{animation:fadein .7s var(--ease) forwards}
.card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.12s}.card:nth-child(3){animation-delay:.19s}.card:nth-child(4){animation-delay:.26s}
@keyframes fadein{to{opacity:1;transform:none}}
.card:hover{transform:rotateY(var(--rY,0deg)) rotateX(var(--rX,0deg)) translateZ(45px) scale(1.06);box-shadow:0 28px 70px rgba(0,0,0,.55)}

/* List & compact */
body.compact{--card-pad:12px}
body.list .grid#grid{grid-template-columns:1fr}
body.list .grid#grid .card{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px}

/* Sheen */
.sheen-on .card::after{content:"";position:absolute;inset:-10% -40% -10% -40%;pointer-events:none;background:linear-gradient(120deg, transparent 40%, rgba(255,255,255,.18) 50%, transparent 60%);transform:translateX(-60%);transition:transform .6s var(--ease)}
.sheen-on .card:hover::after{transform:translateX(60%)}

/* Focused + ring */
.grid.focus-mode .card:not(.focused){opacity:.42;transform:translateZ(-60px) scale(.9);filter:blur(2px);pointer-events:none}
.card.focused{transform:rotateY(0deg) rotateX(0deg) translateZ(110px) scale(1.14);box-shadow:0 44px 110px rgba(0,0,0,.75);filter:brightness(1.08);animation:glowPulse 3s ease-in-out infinite}
@keyframes glowPulse{0%,100%{box-shadow:0 44px 110px rgba(0,0,0,.75)}50%{box-shadow:0 54px 130px rgba(20,40,80,.85)}}
.card.focused::before{content:"";position:absolute;inset:-5px;border-radius:18px;background:conic-gradient(from 0deg, color-mix(in oklab,var(--accent) 35%, #fff), rgba(0,255,200,.25), rgba(255,140,220,.25), color-mix(in oklab,var(--accent) 35%, #fff));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;padding:2px;opacity:.85;filter:blur(8px);animation:borderSpin 12s linear infinite}
@keyframes borderSpin{to{transform:rotate(360deg)}}

.mark{position:absolute;top:10px;right:10px;padding:.2rem .5rem;border-radius:999px;font-size:12px;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.25)}
.mark.alpha{background:var(--ok)}.mark.beta{background:#ff6f61}.mark.old{background:var(--warn)}.mark.touch{background:#00bcd4}
.mark.soon{background:#8089a3}

/* Coming soon cards */
.card.soon{filter:grayscale(.7) opacity(.9)}
.card.soon .btn{pointer-events:none;opacity:.6}
.card.soon .fav{display:none}

/* Fav */
.fav{position:absolute;top:10px;left:10px;width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:var(--panel2);border:1px solid var(--ring);cursor:pointer;box-shadow:var(--shadow);transition:transform .2s}
.fav:hover{transform:scale(1.05)}
.fav svg{width:16px;height:16px;fill:transparent;stroke:var(--muted);stroke-width:1.6}
.fav.on svg{fill:color-mix(in oklab,var(--accent) 50%, #fff);stroke:var(--accent)}

/* Buttons */
.btn{position:relative;border:1px solid var(--ring);background:var(--panel2);color:var(--text);padding:9px 14px;border-radius:10px;cursor:pointer;z-index:10;transition:background .25s, box-shadow .25s, transform .08s var(--ease);user-select:none;-webkit-tap-highlight-color:transparent;transform:translate(var(--mx,0px), var(--my,0px)) scale(var(--ms,1))}
.btn:hover{background:linear-gradient(180deg,var(--accent),var(--panel2));color:#fff;box-shadow:0 0 14px color-mix(in oklab,var(--accent) 55%, #000);transform:translate(var(--mx,0px), var(--my,0px)) scale(1.02)}
.btn:active{--ms:.98; --my:calc(var(--my,0px) + 1px)}
.btn .ripple{position:absolute;border-radius:50%;pointer-events:none;inset:auto;width:10px;height:10px;transform:translate(-50%,-50%);background:rgba(255,255,255,.6);mix-blend-mode:overlay;opacity:0;animation:ripple .6s ease-out forwards}
@keyframes ripple{0%{opacity:.9;transform:translate(-50%,-50%) scale(.2)}100%{opacity:0;transform:translate(-50%,-50%) scale(6)}}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
.modal.show{display:flex}
.card-modal{width:min(820px,94vw);background:var(--panel);border:1px solid var(--ring);border-radius:14px;box-shadow:var(--shadow);padding:14px}
.modal h3{margin:6px 0 10px}
.opt{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--ring);padding:10px;border-radius:10px;background:var(--panel2);margin:8px 0}
.opt > div:first-child{margin-right:8px}

/* Splash */
#splash{position:fixed;inset:0;background:radial-gradient(800px 600px at 30% 20%,color-mix(in oklab,var(--accent) 35%, transparent),transparent 60%),var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;pointer-events:none}
#splash.hide{animation:splash-out .6s ease forwards}
@keyframes splash-out{to{opacity:0;visibility:hidden}}
.s-logo{font-weight:800;letter-spacing:.06em;font-size:34px;display:flex;align-items:center;gap:.6rem}
.s-logo .mark{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 0deg,var(--accent),#8ef5c3,#ffd166,#ff92d0,var(--accent));animation:logo-spin 2s ease-in-out infinite alternate;box-shadow:0 12px 40px rgba(0,0,0,.45)}
.s-sub{margin-top:.4rem;color:var(--muted)}
@keyframes logo-spin{0%{transform:rotate(-8deg) scale(1)}100%{transform:rotate(8deg) scale(1.06)}}
#splash .s-orbit,#splash .s-ring{position:absolute;width:min(46vmin,420px);height:min(46vmin,420px);border-radius:999px;pointer-events:none}
#splash .s-orbit{border:1px solid hsl(0 0% 100% / .14);box-shadow:0 0 60px hsl(210 90% 60% / .18) inset}
#splash .s-ring{border-top:2px solid hsl(210 90% 60% / .75);border-right:2px solid transparent;border-bottom:2px solid transparent;border-left:2px solid transparent;animation:spin 8s linear infinite;filter:drop-shadow(0 0 12px hsl(210 90% 60% / .45))}
@keyframes spin{to{transform:rotate(360deg)}}
.s-progress{position:absolute;bottom:12vh;width:min(52ch, 72vw);height:4px;background:hsl(0 0% 100% / .08);border-radius:999px;overflow:hidden}
.s-progress .bar{display:block;height:100%;width:var(--p,0%);background:linear-gradient(90deg, hsl(210 100% 65% / .9), hsl(210 100% 55% / .9));transition:width .35s ease}

/* Settings (tabs) */
#settingsModal .tabs{position:sticky;top:0;z-index:2;display:flex;gap:.4rem;flex-wrap:wrap;background:var(--panel);border-bottom:1px solid var(--ring);margin:-14px -14px 10px;padding:10px 14px}
#settingsModal .tab{border:1px solid var(--ring);background:var(--panel2);color:var(--text);padding:.4rem .7rem;border-radius:999px;cursor:pointer}
#settingsModal .tab[aria-selected="true"]{background:linear-gradient(180deg,var(--accent),var(--panel2));color:#fff}
#settingsModal .sbar{display:flex;gap:.5rem;align-items:center;margin:6px 0 10px}
#settingsSearch{width:260px;max-width:60vw;background:var(--panel2);border:1px solid var(--ring);color:var(--text);border-radius:10px;padding:.45rem .6rem;outline:0}
#settingsModal .presets{display:flex;gap:.5rem;flex-wrap:wrap;margin:4px 0 10px}
#settingsModal .presets .btn{padding:.42rem .7rem}
#settingsModal .panels{margin-top:6px}
#settingsModal .panel{display:none}
#settingsModal .panel.active{display:block}
#settingsModal .sgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px}
#settingsModal .opt{min-height:64px}
#settingsModal .opt > div:first-child{font-weight:600}
#settingsModal .opt small{display:block;color:var(--muted);font-weight:400;margin-top:.25rem}
#settingsModal .opt .right{display:flex;align-items:center;gap:.6rem}

/* Clock HUD */
#clockHud{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:40;pointer-events:none;display:flex;flex-direction:column;align-items:center;gap:2px;background:color-mix(in oklab,var(--panel),transparent 4%);border:1px solid color-mix(in oklab,var(--ring),#fff 4%);border-radius:14px;padding:8px 12px;backdrop-filter: blur(10px) saturate(1.12);box-shadow: 0 8px 28px rgba(0,0,0,.28)}
#clockHud .t{font:700 16px/1.2 ui-monospace,SFMono-Regular,Menlo,monospace;letter-spacing:.02em;background:linear-gradient(90deg, #fff, color-mix(in oklab,var(--accent) 70%, #fff), #fff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 18px color-mix(in oklab,var(--accent) 30%, #000)}
#clockHud .d{font-size:12px;color:var(--muted)}
#clockHud .ring{position:absolute;inset:-6px;border-radius:inherit;pointer-events:none;opacity:.85;background:conic-gradient(from -90deg, color-mix(in oklab,var(--accent) 65%, #fff) var(--sec,0%), transparent 0);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;padding:6px;filter: blur(6px) saturate(1.25)}
#clockHud .batt{position:absolute;right:8px;top:6px;font:11px/1 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted);opacity:.9}

/* Idle screensaver */
body.idle .grid#grid{filter:blur(2px) brightness(.92)}
body.idle .cursor{opacity:.18}
body.idle .stars2.show{opacity:.4}
</style>
</head>
<body>
<!-- BG -->
<div class="bg" id="bg"></div><div class="aurora" id="aurora"></div><div class="nebula" id="nebula"></div>
<div class="beams" id="beams"></div><div class="stars2" id="stars2"></div><div class="warp" id="warp"></div><div class="scan" id="scan"></div>
<div class="vignette"></div><div class="bokeh"></div><div class="bokeh"></div><div class="bokeh"></div><div class="bokeh"></div>
<div class="cursor" id="cursor"></div>

<!-- Splash -->
<div id="splash" aria-hidden="true">
  <div class="s-logo"><div class="mark"></div><div>OmniMedia</div></div>
  <div class="s-sub">Landing v8.3</div>
  <div class="s-orbit"></div><div class="s-ring"></div>
  <div id="sProgress" class="s-progress" aria-hidden="true"><span class="bar"></span></div>
</div>

<!-- Clock HUD -->
<div id="clockHud" aria-hidden="true">
  <div class="ring" id="clockRing"></div>
  <div class="t" id="clockTime">--:--:--</div>
  <div class="d" id="clockDate">----</div>
  <div class="batt" id="clockBatt" hidden>--%</div>
</div>

<div class="wrap" aria-live="polite">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1 id="title" class="shimmer">OmniMedia â€“ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</h1>
      <span class="version">v8.3</span>
      <span id="netBadge" class="badge">Online</span>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;z-index:20">
      <button id="helpBtn" class="btn" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">ï¼Ÿ</button>
      <button id="installBtn" class="btn" title="ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" style="display:none">â¬‡ï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
      <button id="shareBtn" class="btn" title="å…±æœ‰">å…±æœ‰</button>
      <button id="settingsBtn" class="btn" title="è¨­å®š">âš™ï¸</button>
      <button id="langBtn" class="btn" aria-label="è¨€èªåˆ‡æ›¿">ğŸŒ JP</button>
      <button id="themeBtn" class="btn" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™</button>
    </div>
  </header>

  <div class="toolbar">
    <input id="filter" type="search" placeholder="æ¤œç´¢: Î± / Î² / PC / Touch â€¦" aria-label="æ¤œç´¢">
  </div>

  <main>
    <!-- Section: Omni Player Series -->
    <section id="series-omni" class="section">
      <div class="sec-title">
        <h2 id="secOmniTitle">Omni Player ã‚·ãƒªãƒ¼ã‚º</h2>
        <span class="hint" id="secOmniHint">ä¸»è¦ãƒ©ã‚¤ãƒ³ã‚¢ãƒƒãƒ—</span>
      </div>

      <div class="grid" id="grid">
        <article class="card" tabindex="0" draggable="true" data-tags="alpha stable æ¨å¥¨" data-slug="alpha" data-href="./omni_pc_Î±.html">
          <button class="fav" title="ãŠæ°—ã«å…¥ã‚Š"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>
          <span class="mark alpha" id="markAlpha">æ¨å¥¨</span>
          <h2 id="titleAlpha" data-orig>Omni Player Î±</h2>
          <p id="descAlpha" data-orig>å®‰å®šç‰ˆã€‚å®Œå…¨æ©Ÿèƒ½ãƒ»ä½è² è·ã§æ¨å¥¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚</p>
          <a class="btn" href="./omni_pc_Î±.html" id="btnAlpha">é–‹ã</a>
        </article>

        <article class="card" tabindex="0" draggable="true" data-tags="beta test å®Ÿé¨“" data-slug="beta" data-href="./omni_pc_Î².html">
          <button class="fav" title="ãŠæ°—ã«å…¥ã‚Š"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>
          <span class="mark beta" id="markBeta">ä½¿ç”¨ä¸å¯</span>
          <h2 id="titleBeta" data-orig>Omni Player Î²</h2>
          <p id="descBeta" data-orig>ç¾åœ¨ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
          <a class="btn" href="./omni_pc_Î².html" id="btnBeta">é–‹ã</a>
        </article>

        <article class="card" tabindex="0" draggable="true" data-tags="pc old æ—§ç‰ˆ" data-slug="pc" data-href="./omni_pc.html">
          <button class="fav" title="ãŠæ°—ã«å…¥ã‚Š"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>
          <span class="mark old" id="markPc">éæ¨å¥¨</span>
          <h2 id="titlePc" data-orig>Omni Player PC</h2>
          <p id="descPc" data-orig>æ—§ç‰ˆã€‚éå»æ§‹æˆç”¨ã¨ã—ã¦æ®‹å­˜ã€‚</p>
          <a class="btn" href="./omni_pc.html" id="btnPc">é–‹ã</a>
        </article>

        <article class="card" tabindex="0" draggable="true" data-tags="touch mobile ã‚¹ãƒãƒ›" data-slug="touch" data-href="./omni_touch.html">
          <button class="fav" title="ãŠæ°—ã«å…¥ã‚Š"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>
          <span class="mark touch" id="markTouch">ã‚¹ãƒãƒ›</span>
          <h2 id="titleTouch" data-orig>Omni Player Touch</h2>
          <p id="descTouch" data-orig>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ã«æœ€é©åŒ–ã•ã‚ŒãŸæ“ä½œæ€§ã€‚</p>
          <a class="btn" href="./omni_touch.html" id="btnTouch">é–‹ã</a>
        </article>
      </div>

      <div class="scroll-cue">
        <button class="btn" id="scrollToNew">â†“ <span id="cueNewText">æ–°ã‚·ãƒªãƒ¼ã‚ºï¼ˆComing Soonï¼‰ã¸</span></button>
      </div>
    </section>

    <!-- Section: New Series -->
    <section id="series-new" class="section" aria-label="new series">
      <div class="sec-title">
        <h2 id="secNewTitle">æ–°ã‚·ãƒªãƒ¼ã‚º</h2>
        <span class="hint" id="secNewHint">Beta & Coming Soon</span>
      </div>

      <div class="grid" id="gridSoon">
        <!-- Replaced: Omni Creator -> Convert (Î²) -->
        <article class="card" tabindex="0" data-tags="convert beta æ–°" data-href="./convert.html">
          <span class="mark beta" data-i18n-mark="betaBadge">Î²ç‰ˆ</span>
          <h2 data-i18n="convertTitle">Omni Convert</h2>
          <p data-i18n="convertDesc">å¤šå½¢å¼ã®å…¥å‡ºåŠ›ã«å¯¾å¿œã™ã‚‹é«˜é€Ÿå¤‰æ›ãƒ„ãƒ¼ãƒ«ã€‚</p>
          <a class="btn" href="./convert.html" data-i18n="openBtn">é–‹ã</a>
        </article>

        <!-- Keep Omni Live as Coming Soon -->
        <article class="card soon" tabindex="-1" data-tags="coming soon" aria-disabled="true">
          <span class="mark soon">Coming Soon</span>
          <h2>Omni Live</h2>
          <p>ä½é…å»¶ãƒ»ãƒãƒ«ãƒã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ©ã‚¤ãƒ–ã€‚</p>
          <a class="btn">æº–å‚™ä¸­</a>
        </article>

        <!-- Replaced: Omni Studio -> Editor (Î²) -->
        <article class="card" tabindex="0" data-tags="editor beta æ–°" data-href="./editor.html">
          <span class="mark beta" data-i18n-mark="betaBadge">Î²ç‰ˆ</span>
          <h2 data-i18n="editorTitle">Omni Editor</h2>
          <p data-i18n="editorDesc">è»½å¿«ãªUIã§åŸºæœ¬ç·¨é›†ã¨ãƒãƒƒãƒå‡¦ç†ã‚’ç´ æ—©ãã€‚</p>
          <a class="btn" href="./editor.html" data-i18n="openBtn">é–‹ã</a>
        </article>
      </div>
    </section>
  </main>

  <footer id="footerText">Â© 2025 OmniMedia â€“ ã™ã¹ã¦ã®ä½“é¨“ã‚’ã²ã¨ã¤ã«ã€‚</footer>
</div>

<!-- Settings -->
<div class="modal" id="settingsModal" aria-hidden="true">
  <div class="card-modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <h3 id="settingsTitle">è¨­å®š</h3>

    <div class="tabs" role="tablist">
      <button class="tab" type="button" data-tab="display" aria-selected="true">è¡¨ç¤º</button>
      <button class="tab" type="button" data-tab="effects" aria-selected="false">ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</button>
      <button class="tab" type="button" data-tab="interaction" aria-selected="false">æ“ä½œ</button>
      <button class="tab" type="button" data-tab="data" aria-selected="false">ãƒ‡ãƒ¼ã‚¿</button>
    </div>

    <div class="sbar">
      <input id="settingsSearch" type="search" placeholder="è¨­å®šã‚’æ¤œç´¢â€¦" aria-label="è¨­å®šã‚’æ¤œç´¢">
      <div class="presets">
        <button class="btn" id="presetBalanced" title="ãƒãƒ©ãƒ³ã‚¹">ãƒãƒ©ãƒ³ã‚¹</button>
        <button class="btn" id="presetPerformance" title="çœã‚¨ãƒé‡è¦–">çœã‚¨ãƒé‡è¦–</button>
        <button class="btn" id="presetAesthetic" title="æ¼”å‡ºé‡è¦–">æ¼”å‡ºé‡è¦–</button>
      </div>
    </div>

    <div class="panels">
      <!-- è¡¨ç¤º -->
      <section class="panel active" data-panel="display">
        <div class="sgrid">
          <div class="opt">
            <div>ãƒ†ãƒ¼ãƒ<small>ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯/OSé€£å‹•/æ™‚é–“ï¼ˆauto-timeï¼‰</small></div>
            <div class="right">
              <select id="optTheme">
                <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
                <option value="light">ãƒ©ã‚¤ãƒˆ</option>
                <option value="auto">è‡ªå‹•ï¼ˆOSé€£å‹•ï¼‰</option>
                <option value="auto-time">æ™‚é–“ï¼ˆæœ/å¤œã§è‡ªå‹•ï¼‰</option>
              </select>
            </div>
          </div>
          <div class="opt">
            <div>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼<small>é…è‰²ã®åŸºæº–è‰²</small></div>
            <div class="right">
              <input type="color" id="optAccent" value="#74b3ff" title="ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²">
              <button class="btn" id="optAccentRand">ãƒ©ãƒ³ãƒ€ãƒ </button>
              <label><input type="checkbox" id="optAccentCycle"> è‡ªå‹•ã‚·ãƒ•ãƒˆ</label>
            </div>
          </div>
          <div class="opt">
            <div>ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º<small>ã‚«ãƒ¼ãƒ‰ã®ä½™ç™½ã‚’å°ã•ã</small></div>
            <div class="right"><label><input type="checkbox" id="optCompact"> æœ‰åŠ¹</label></div>
          </div>
          <div class="opt">
            <div>ãƒªã‚¹ãƒˆè¡¨ç¤º<small>ä¸Šæ®µï¼ˆOmni Playerï¼‰ã‚’1åˆ—ã«</small></div>
            <div class="right"><label><input type="checkbox" id="optListView"> æœ‰åŠ¹</label></div>
          </div>
          <div class="opt">
            <div>ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚·ãƒãƒ¼<small>è¦‹å‡ºã—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ</small></div>
            <div class="right"><label><input type="checkbox" id="optTitleShimmer" checked> æœ‰åŠ¹</label></div>
          </div>
          <div class="opt">
            <div>æ™‚è¨ˆHUD<small>ç¾åœ¨æ™‚åˆ»ãƒ»æ›œæ—¥ãƒ»å¹´æœˆæ—¥ã‚’ä¸Šéƒ¨ä¸­å¤®ã«è¡¨ç¤º</small></div>
            <div class="right"><label><input type="checkbox" id="optClock" checked> è¡¨ç¤º</label></div>
          </div>
          <div class="opt">
            <div>çœã‚¨ãƒãƒ»ä½ã‚¹ãƒšãƒƒã‚¯<small>ã‚¢ãƒ‹ãƒ¡æ¸›/è¦–å·®ãƒ»é‡ã„æ¼”å‡ºã‚’æŠ‘åˆ¶</small></div>
            <div class="right"><label><input type="checkbox" id="optReduce"> æœ‰åŠ¹</label></div>
          </div>
          <div class="opt">
            <div>è‡ªå‹•ç¯€é›»ï¼ˆFPS<30ï¼‰<small>ä¸€æ™‚çš„ã«FXã‚’ãƒŸãƒ¥ãƒ¼ãƒˆ</small></div>
            <div class="right"><label><input type="checkbox" id="optAutoReduce"> æœ‰åŠ¹</label></div>
          </div>
          <div class="opt">
            <div>FPSãƒ¡ãƒ¼ã‚¿ãƒ¼<small>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèªç”¨</small></div>
            <div class="right"><label><input type="checkbox" id="optFps"> è¡¨ç¤º</label></div>
          </div>
          <div class="opt">
            <div>ãŠæ°—ã«å…¥ã‚Šã‚’å…ˆé ­<small>ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’ä¸¦ã¹æ›¿ãˆ</small></div>
            <div class="right"><label><input type="checkbox" id="optFavFirst" checked> æœ‰åŠ¹</label></div>
          </div>
        </div>
      </section>

      <!-- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
      <section class="panel" data-panel="effects">
        <div class="sgrid">
          <div class="opt"><div>èƒŒæ™¯ãƒ“ãƒ¼ãƒ <small>æŸ”ã‚‰ã‹ãªå…‰æŸ±ã®æºã‚Œ</small></div><div class="right"><label><input type="checkbox" id="optBeams" checked> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>æ˜Ÿç©ºãƒãƒ©ã¤ã<small>å°ã•ãªè¼ç‚¹ã®ç¬ã</small></div><div class="right"><label><input type="checkbox" id="optStars" checked> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ãƒ¯ãƒ¼ãƒ—ãƒ©ã‚¤ãƒ³<small>æ ¼å­ã®æµã‚Œ</small></div><div class="right"><label><input type="checkbox" id="optWarp"> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³<small>CRTé¢¨ã®èµ°æŸ»ç·š</small></div><div class="right"><label><input type="checkbox" id="optScan"> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ã‚«ãƒ¼ã‚½ãƒ«ãƒ»ãƒˆãƒ¬ã‚¤ãƒ«<small>ãƒã‚¤ãƒ³ã‚¿ã®æ®‹å…‰</small></div><div class="right"><label><input type="checkbox" id="optTrail" checked> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ã‚«ãƒ¼ãƒ‰ãƒ»ã‚·ãƒ¼ãƒ³ï¼ˆå…‰ç­‹ï¼‰<small>ã‚«ãƒ¼ãƒ‰æ¨ªæ–­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ</small></div><div class="right"><label><input type="checkbox" id="optSheen" checked> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ãƒœã‚¿ãƒ³ãƒ»ãƒã‚°ãƒãƒƒãƒˆ<small>ãƒœã‚¿ãƒ³ãŒãƒã‚¦ã‚¹ã«è¿½å¾“</small></div><div class="right"><label><input type="checkbox" id="optMagnet" checked> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã‚ªãƒ¼ãƒˆå·¡å›<small>ä½•ã‚‚æ“ä½œã—ãªã„ã¨é¸æŠã‚«ãƒ¼ãƒ‰ã‚’é †ã«è¡¨ç¤º</small></div><div class="right"><label><input type="checkbox" id="optAutoCycle"> æœ‰åŠ¹</label></div></div>
          <div class="opt">
            <div>èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é‡<small>è½ä¸‹ç²’å­ã®å¯†åº¦</small></div>
            <div class="right"><input type="range" id="optParticles" min="0" max="120" step="6" value="48"></div>
          </div>
        </div>
      </section>

      <!-- æ“ä½œ -->
      <section class="panel" data-panel="interaction">
        <div class="sgrid">
          <div class="opt"><div>3Dãƒãƒ«ãƒˆ<small>ã‚«ãƒ¼ãƒ‰ãŒãƒã‚¦ã‚¹ã§å‚¾ã</small></div><div class="right"><label><input type="checkbox" id="optTilt"> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰<small>é¸æŠã‚«ãƒ¼ãƒ‰ã‚’å¼·èª¿è¡¨ç¤º</small></div><div class="right"><label><input type="checkbox" id="optFocus" checked> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£<small>ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚„ãŠæ°—ã«å…¥ã‚Šæ™‚ã®ç´™å¹é›ª</small></div><div class="right"><label><input type="checkbox" id="optConfetti" checked> æœ‰åŠ¹</label></div></div>
          <div class="opt"><div>ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ<small>ã‚«ãƒ¼ãƒ‰ã®é †åºã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</small></div><div class="right"><label><input type="checkbox" id="optDragOrder" checked> æœ‰åŠ¹</label></div></div>
        </div>
      </section>

      <!-- ãƒ‡ãƒ¼ã‚¿ -->
      <section class="panel" data-panel="data">
        <div class="sgrid">
          <div class="opt">
            <div>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«<small>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å…±æœ‰ã«ä¾¿åˆ©</small></div>
            <div class="right" style="flex-wrap:wrap">
              <button class="btn" id="optExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
              <label class="btn" style="cursor:pointer">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                <input type="file" id="optImport" accept="application/json" style="display:none">
              </label>
              <button class="btn" id="optReset" title="åˆæœŸåŒ–">åˆæœŸåŒ–</button>
              <button class="btn" id="optResetOrder" title="é †åºãƒªã‚»ãƒƒãƒˆ">é †åºãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div style="text-align:right;margin-top:10px">
      <button class="btn" id="optClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- Help -->
<div class="modal" id="helpModal" aria-hidden="true">
  <div class="card-modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <h3 id="helpTitle">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
    <ul style="margin:.4rem 0 0 1rem;line-height:1.8">
      <li><b>Ctrl/Cmd + K</b> ã¾ãŸã¯ <b>/</b>â€¦ æ¤œç´¢ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</li>
      <li><b>â† / â†’</b>â€¦ ã‚«ãƒ¼ãƒ‰ç§»å‹•ã€€<b>Enter</b>â€¦ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹/é–‹ã</li>
      <li><b>1â€“4</b>â€¦ å¯¾å¿œã‚«ãƒ¼ãƒ‰ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã€€<b>O</b>â€¦ é–‹ã</li>
      <li><b>X</b>â€¦ FXãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿ã€€<b>L</b>â€¦ ãƒªã‚¹ãƒˆè¡¨ç¤ºã€€<b>C</b>â€¦ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º</li>
      <li><b>Esc</b>â€¦ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤ã€€<b>?</b>â€¦ ã“ã®ãƒ˜ãƒ«ãƒ—</li>
      <li><b>ãƒ‰ãƒ©ãƒƒã‚°</b>â€¦ ä¸¦ã¹æ›¿ãˆï¼ˆæœ‰åŠ¹æ™‚ï¼‰</li>
    </ul>
    <div style="text-align:right;margin-top:8px"><button class="btn" id="helpClose">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<!-- Ctx menu / HUD -->
<div id="ctx" role="menu" aria-hidden="true">
  <div class="row" data-cmd="open">é–‹ã</div>
  <div class="row" data-cmd="newtab">æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</div>
  <div class="row" data-cmd="copy">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</div>
  <div class="row" data-cmd="fav">ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /è§£é™¤</div>
</div>
<div id="fps">fps: --</div>
<div id="toasts" aria-live="polite"></div>

<script>
/* ===== Refs ===== */
const meta = document.getElementById('themeColorMeta');
const themeBtn = document.getElementById('themeBtn');
const langBtn  = document.getElementById('langBtn');

/* Sections/grids */
const grid   = document.getElementById('grid');      // Omni Player ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚°ãƒªãƒƒãƒ‰
const gridSoon = document.getElementById('gridSoon'); // æ–°ã‚·ãƒªãƒ¼ã‚ºï¼ˆä¸‹æ®µï¼‰

const cursor = document.getElementById('cursor');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const optReduce = document.getElementById('optReduce');
const optTilt = document.getElementById('optTilt');
const optFocus = document.getElementById('optFocus');
const optConfetti = document.getElementById('optConfetti');
const optParticles = document.getElementById('optParticles');
const optTheme = document.getElementById('optTheme');
const optAccent = document.getElementById('optAccent');
const optAccentRand = document.getElementById('optAccentRand');
const optAccentCycle = document.getElementById('optAccentCycle');
const optFps = document.getElementById('optFps');
const optFavFirst = document.getElementById('optFavFirst');
const optAutoReduce = document.getElementById('optAutoReduce');
const optDragOrder = document.getElementById('optDragOrder');
/* æ–°è¦è¡¨ç¤ºç³» */
const optCompact = document.getElementById('optCompact');
const optListView = document.getElementById('optListView');
const optTitleShimmer = document.getElementById('optTitleShimmer');
const optClock = document.getElementById('optClock');

const filterInput = document.getElementById('filter');
const installBtn = document.getElementById('installBtn');
const shareBtn = document.getElementById('shareBtn');
const helpBtn = document.getElementById('helpBtn');
const helpModal = document.getElementById('helpModal');
const splash = document.getElementById('splash');
const ctxMenu = document.getElementById('ctx');
const fpsBox = document.getElementById('fps');
const netBadge = document.getElementById('netBadge');
const nebulaEl = document.getElementById('nebula');

const beams = document.getElementById('beams');
const stars = document.getElementById('stars2');
const warp  = document.getElementById('warp');
const scan  = document.getElementById('scan');
const bgEl  = document.getElementById('bg');
const auroraEl = document.getElementById('aurora');

/* Effects refs */
const optBeams = document.getElementById('optBeams');
const optStars = document.getElementById('optStars');
const optWarp  = document.getElementById('optWarp');
const optScan  = document.getElementById('optScan');
const optTrail = document.getElementById('optTrail');
const optSheen = document.getElementById('optSheen');
const optMagnet= document.getElementById('optMagnet');
const optAutoCycle = document.getElementById('optAutoCycle');

const optExport=document.getElementById('optExport');
const optImport=document.getElementById('optImport');
const optReset=document.getElementById('optReset');
const optResetOrder=document.getElementById('optResetOrder');

const clockTime = document.getElementById('clockTime');
const clockDate = document.getElementById('clockDate');
const clockRing = document.getElementById('clockRing');
const clockBatt = document.getElementById('clockBatt');
const clockHud  = document.getElementById('clockHud');

/* Section scroll cue */
const scrollToNew = document.getElementById('scrollToNew');

/* ===== Store & keys ===== */
const store={get(k,d){try{const v=localStorage.getItem(k);return v==null?d:JSON.parse(v)}catch{ return d }},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
const themeKey='om.theme', settingsKey='om.settings', favKey='om.favs', accentKey='om.accent', orderKey='om.order';

/* ===== Settings with defaults ===== */
const settings = Object.assign(
  /* base */
  { reduce:false, autoReduce:true, tilt:true, focus:true, confetti:true, particles:(innerWidth>1200?90:48),
    accentCycle:false, dragOrder:true },
  /* effects */
  { beams:true, stars:true, warp:false, scan:false, trail:true, sheen:true, magnet:true, autoCycle:false },
  /* ui */
  { fps:false, favFirst:true, compact:false, listView:false, titleShimmer:true, clock:true },
  store.get(settingsKey, {})
);

/* ===== Mute flag (TDZå›é¿) ===== */
let fxMuted = false;
/* URL fx=off å…ˆé©ç”¨ */
(function(){ try{ const u=new URL(location.href); if((u.searchParams.get('fx')||'').toLowerCase()==='off'){ fxMuted = true; } }catch{} })();

/* ===== Accent ===== */
let accent = store.get(accentKey, getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#74b3ff');
applyAccent(accent);
function applyAccent(hex){ document.documentElement.style.setProperty('--accent', hex); if(optAccent) optAccent.value = hex; }

/* Accent auto shift */
let accentShiftTimer=null, accentHue=0;
function hexToHsl(H){let r=0,g=0,b=0;if(H.length===4){r="0x"+H[1]+H[1];g="0x"+H[2]+H[2];b="0x"+H[3]+H[3]}else{r="0x"+H[1]+H[2];g="0x"+H[3]+H[4];b="0x"+H[5]+H[6]}r/=255;g/=255;b/=255;const cmin=Math.min(r,g,b), cmax=Math.max(r,g,b), delta=cmax-cmin;let h=0,s=0,l=(cmax+cmin)/2;if(delta!==0){if(cmax===r) h=((g-b)/delta)%6; else if(cmax===g) h=(b-r)/delta+2; else h=(r-g)/delta+4; h=Math.round(h*60); if(h<0) h+=360; s=delta/(1-Math.abs(2*l-1));} s=Math.round(s*100); l=Math.round(l*100); return [h,s,l];}
function hslToHex(h,s,l){s/=100;l/=100;const k=n=> (n+ h/30)%12;const a=s*Math.min(l,1-l);const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));const toHex=x=> Math.round(x*255).toString(16).padStart(2,'0');return "#"+toHex(f(0))+toHex(f(8))+toHex(f(4));}
function startAccentShift(){ if(accentShiftTimer) return; const [h,s,l]=hexToHsl(accent); accentHue=h; accentShiftTimer=setInterval(()=>{ accentHue=(accentHue+0.6)%360; applyAccent(hslToHex(accentHue,s,l)); }, 1000); }
function stopAccentShift(){ if(accentShiftTimer){ clearInterval(accentShiftTimer); accentShiftTimer=null; applyAccent(accent); }}

/* ===== Theme ===== */
const themePref = store.get(themeKey,'dark');
applyTheme(themePref);
if(optTheme) optTheme.value = themePref;
themeBtn.textContent = displayThemeIcon(themePref);
function getSystemTheme(){ return matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' }
function timeOfDayTheme(){ const h=new Date().getHours(); return (h>=19||h<7)?'dark':'light' }
function applyTheme(mode){
  const m = mode==='auto' ? getSystemTheme() : (mode==='auto-time' ? timeOfDayTheme() : mode);
  document.documentElement.setAttribute('data-theme', m);
  meta.setAttribute('content', m==='light' ? '#f4f7fb' : '#0b0e12');
}
function displayThemeIcon(mode){ if(mode==='auto') return 'ğŸŒ“'; if(mode==='auto-time') return 'â°'; return mode==='light' ? 'â˜€ï¸' : 'ğŸŒ™'; }
themeBtn.addEventListener('click',()=>{
  const cur = store.get(themeKey,'dark');
  const seq = ['dark','light','auto','auto-time'];
  const next = seq[(seq.indexOf(cur)+1)%seq.length];
  store.set(themeKey,next); themeBtn.textContent=displayThemeIcon(next); applyTheme(next);
});
optTheme?.addEventListener('change',()=>{ store.set(themeKey, optTheme.value); themeBtn.textContent=displayThemeIcon(optTheme.value); applyTheme(optTheme.value) });
(function(){const mql=matchMedia('(prefers-color-scheme: dark)'); const cb=()=>{ if(store.get(themeKey,'dark')==='auto') applyTheme('auto') }; mql.addEventListener? mql.addEventListener('change',cb):mql.addListener(cb); })();

/* ===== Language ===== */
const dict={
  ja:{lang:"JP",footer:"Â© 2025 OmniMedia â€“ ã™ã¹ã¦ã®ä½“é¨“ã‚’ã²ã¨ã¤ã«ã€‚",alpha:"æ¨å¥¨",beta:"ä½¿ç”¨ä¸å¯",old:"éæ¨å¥¨",touch:"ã‚¹ãƒãƒ›",
      alphaTitle:"Omni Player Î±",betaTitle:"Omni Player Î²",oldTitle:"Omni Player PC",touchTitle:"Omni Player Touch",
      alphaDesc:"å®‰å®šç‰ˆã€‚å®Œå…¨æ©Ÿèƒ½ãƒ»ä½è² è·ã§æ¨å¥¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚",betaDesc:"ç¾åœ¨ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚",oldDesc:"æ—§ç‰ˆã€‚éå»æ§‹æˆç”¨ã¨ã—ã¦æ®‹å­˜ã€‚",touchDesc:"ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ã«æœ€é©åŒ–ã•ã‚ŒãŸæ“ä½œæ€§ã€‚",
      searchPH:"æ¤œç´¢: Î± / Î² / PC / Touch â€¦", secOmni:"Omni Player ã‚·ãƒªãƒ¼ã‚º", secOmniHint:"ä¸»è¦ãƒ©ã‚¤ãƒ³ã‚¢ãƒƒãƒ—",
      secNew:"æ–°ã‚·ãƒªãƒ¼ã‚º", secNewHint:"Beta & Coming Soon", cueNew:"æ–°ã‚·ãƒªãƒ¼ã‚ºï¼ˆComing Soonï¼‰ã¸",
      /* New series (Convert / Editor) */
      betaBadge:"Î²ç‰ˆ", openBtn:"é–‹ã",
      convertTitle:"Omni Convert", convertDesc:"å¤šå½¢å¼ã®å…¥å‡ºåŠ›ã«å¯¾å¿œã™ã‚‹é«˜é€Ÿå¤‰æ›ãƒ„ãƒ¼ãƒ«ã€‚",
      editorTitle:"Omni Editor",  editorDesc:"è»½å¿«ãªUIã§åŸºæœ¬ç·¨é›†ã¨ãƒãƒƒãƒå‡¦ç†ã‚’ç´ æ—©ãã€‚"},
  en:{lang:"EN",footer:"Â© 2025 OmniMedia â€“ One experience for all.",alpha:"Rec",beta:"Test",old:"Old",touch:"Mobile",
      alphaTitle:"Omni Player Î±",betaTitle:"Omni Player Î²",oldTitle:"Omni Player PC",touchTitle:"Omni Player Touch",
      alphaDesc:"Stable build. Fully featured and optimized.",betaDesc:"Not available.",oldDesc:"Legacy version kept for compatibility.",touchDesc:"Optimized for smartphones and tablets.",
      searchPH:"Search: alpha / beta / PC / Touch â€¦", secOmni:"Omni Player Series", secOmniHint:"Main lineup",
      secNew:"New Series", secNewHint:"Beta & Coming Soon", cueNew:"Go to New Series (Coming Soon)",
      betaBadge:"Beta", openBtn:"Open",
      convertTitle:"Omni Convert", convertDesc:"Fast converter supporting many input/output formats.",
      editorTitle:"Omni Editor",  editorDesc:"Lightweight editor for essentials and batch runs."},
  ko:{lang:"KR",footer:"Â© 2025 OmniMedia â€“ ëª¨ë“  ê²½í—˜ì„ í•˜ë‚˜ë¡œ.",alpha:"ì¶”ì²œ",beta:"í…ŒìŠ¤íŠ¸",old:"ë¹„ì¶”ì²œ",touch:"ëª¨ë°”ì¼",
      alphaTitle:"Omni Player Î±",betaTitle:"Omni Player Î²",oldTitle:"Omni Player PC",touchTitle:"Omni Player Touch",
      alphaDesc:"ì•ˆì • ë²„ì „, ì™„ì „í•œ ê¸°ëŠ¥ê³¼ ìµœì í™” ì„±ëŠ¥.",betaDesc:"í˜„ì¬ ì‚¬ìš© ë¶ˆê°€.",oldDesc:"ì´ì „ ë²„ì „(ë¹„ì¶”ì²œ).",touchDesc:"ìŠ¤ë§ˆíŠ¸í°Â·íƒœë¸”ë¦¿ì— ìµœì í™”.",
      searchPH:"ê²€ìƒ‰: ì•ŒíŒŒ / ë² íƒ€ / PC / Touch â€¦", secOmni:"Omni Player ì‹œë¦¬ì¦ˆ", secOmniHint:"ì£¼ìš” ë¼ì¸ì—…",
      secNew:"ì‹ ê·œ ì‹œë¦¬ì¦ˆ", secNewHint:"Beta & ì¶œì‹œ ì˜ˆì •", cueNew:"ì‹ ê·œ ì‹œë¦¬ì¦ˆ(ì¶œì‹œ ì˜ˆì •)ë¡œ",
      betaBadge:"ë² íƒ€", openBtn:"ì—´ê¸°",
      convertTitle:"Omni Convert", convertDesc:"ë‹¤ì–‘í•œ í˜•ì‹ì˜ ì…ì¶œë ¥ì„ ì§€ì›í•˜ëŠ” ê³ ì† ë³€í™˜ ë„êµ¬.",
      editorTitle:"Omni Editor",  editorDesc:"í•µì‹¬ í¸ì§‘ê³¼ ë°°ì¹˜ë¥¼ ë¹ ë¥´ê²Œ ì²˜ë¦¬."},
  zh:{lang:"ä¸­æ–‡",footer:"Â© 2025 OmniMedia â€“ æ±‡èšæ‰€æœ‰ä½“éªŒã€‚",alpha:"æ¨è",beta:"æµ‹è¯•",old:"æ—§ç‰ˆ",touch:"ç§»åŠ¨",
      alphaTitle:"Omni Player Î±",betaTitle:"Omni Player Î²",oldTitle:"Omni Player PC",touchTitle:"Omni Player Touch",
      alphaDesc:"ç¨³å®šç‰ˆï¼Œå®Œæ•´åŠŸèƒ½ä¸æœ€ä½³æ€§èƒ½ã€‚",betaDesc:"å½“å‰ä¸å¯ç”¨ã€‚",oldDesc:"æ—§ç‰ˆæœ¬ï¼Œä»…ä¿ç•™å…¼å®¹ã€‚",touchDesc:"é’ˆå¯¹æ‰‹æœºå’Œå¹³æ¿ä¼˜åŒ–ã€‚",
      searchPH:"æœç´¢: Î± / Î² / PC / Touch â€¦", secOmni:"Omni Player ç³»åˆ—", secOmniHint:"ä¸»åŠ›äº§å“çº¿",
      secNew:"æ–°ç³»åˆ—", secNewHint:"Beta & æ•¬è¯·æœŸå¾…", cueNew:"å‰å¾€æ–°ç³»åˆ—ï¼ˆæ•¬è¯·æœŸå¾…ï¼‰",
      betaBadge:"æµ‹è¯•ç‰ˆ", openBtn:"æ‰“å¼€",
      convertTitle:"Omni Convert", convertDesc:"æ”¯æŒå¤šç§è¾“å…¥/è¾“å‡ºæ ¼å¼çš„é«˜é€Ÿè½¬æ¢å·¥å…·ã€‚",
      editorTitle:"Omni Editor",  editorDesc:"è½»é‡ç¼–è¾‘å™¨ï¼Œå¿«é€Ÿå®ŒæˆåŸºç¡€ç¼–è¾‘ä¸æ‰¹å¤„ç†ã€‚"},
  ru:{lang:"RU",footer:"Â© 2025 OmniMedia â€“ Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¾Ğ¿Ñ‹Ñ‚ Ğ´Ğ»Ñ Ğ²ÑĞµÑ….",alpha:"Ğ ĞµĞºĞ¾Ğ¼.",beta:"Ğ¢ĞµÑÑ‚",old:"Ğ¡Ñ‚Ğ°Ñ€.",touch:"ĞœĞ¾Ğ±.",
      alphaTitle:"Omni Player Î±",betaTitle:"Omni Player Î²",oldTitle:"Omni Player PC",touchTitle:"Omni Player Touch",
      alphaDesc:"Ğ¡Ñ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒÑ.",betaDesc:"ĞĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾.",oldDesc:"Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ (Ğ½Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ).",touchDesc:"ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ ÑĞ¼Ğ°Ñ€Ñ‚Ñ„Ğ¾Ğ½Ğ¾Ğ² Ğ¸ Ğ¿Ğ»Ğ°Ğ½ÑˆĞµÑ‚Ğ¾Ğ².",
      searchPH:"ĞŸĞ¾Ğ¸ÑĞº: Î± / Î² / PC / Touch â€¦", secOmni:"Ğ¡ĞµÑ€Ğ¸Ñ Omni Player", secOmniHint:"ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ»Ğ¸Ğ½ĞµĞ¹ĞºĞ°",
      secNew:"ĞĞ¾Ğ²Ğ°Ñ ÑĞµÑ€Ğ¸Ñ", secNewHint:"Ğ‘ĞµÑ‚Ğ° Ğ¸ Ğ¡ĞºĞ¾Ñ€Ğ¾", cueNew:"Ğš Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞµÑ€Ğ¸Ğ¸ (ÑĞºĞ¾Ñ€Ğ¾)",
      betaBadge:"Ğ‘ĞµÑ‚Ğ°", openBtn:"ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ",
      convertTitle:"Omni Convert", convertDesc:"Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ĞµÑ€ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ².",
      editorTitle:"Omni Editor",  editorDesc:"Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¸ Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸."},
  fr:{lang:"FR",footer:"Â© 2025 OmniMedia â€“ Une expÃ©rience unique pour tous.",alpha:"Recom.",beta:"Test",old:"Anc.",touch:"Mobile",
      alphaTitle:"Omni Player Î±",betaTitle:"Omni Player Î²",oldTitle:"Omni Player PC",touchTitle:"Omni Player Touch",
      alphaDesc:"Version stable, complÃ¨te et optimisÃ©e.",betaDesc:"Indisponible.",oldDesc:"Ancienne version (non recommandÃ©e).",touchDesc:"OptimisÃ© pour smartphones et tablettes.",
      searchPH:"Rechercher : Î± / Î² / PC / Touch â€¦", secOmni:"SÃ©rie Omni Player", secOmniHint:"Gamme principale",
      secNew:"Nouvelle sÃ©rie", secNewHint:"BÃªta & BientÃ´t", cueNew:"Aller Ã  la nouvelle sÃ©rie (bientÃ´t)",
      betaBadge:"BÃªta", openBtn:"Ouvrir",
      convertTitle:"Omni Convert", convertDesc:"Convertisseur rapide prenant en charge de nombreux formats.",
      editorTitle:"Omni Editor",  editorDesc:"Ã‰diteur lÃ©ger pour lâ€™essentiel et les traitements par lot."},
};
const langKey='om.lang';
let lang = store.get(langKey,null);
if(!lang){
  const nav=(navigator.language||'ja').slice(0,2);
  lang=(['ja','en','zh','ko','ru','fr'].includes(nav))?(nav==='ja'?'ja':nav):'ja';
  store.set(langKey, lang);
}
applyLang(lang);
langBtn.addEventListener('click',()=>{
  const keys=Object.keys(dict);
  lang=keys[(keys.indexOf(lang)+1)%keys.length];
  store.set(langKey,lang);applyLang(lang);startClock();
});
function el(id){return document.getElementById(id)}
function applyLang(l){
  const d=dict[l]||dict.ja;
  el('markAlpha').textContent=d.alpha;el('markBeta').textContent=d.beta;el('markPc').textContent=d.old;el('markTouch').textContent=d.touch;
  el('titleAlpha').textContent=d.alphaTitle;el('titleBeta').textContent=d.betaTitle;el('titlePc').textContent=d.oldTitle;el('titleTouch').textContent=d.touchTitle;
  el('descAlpha').textContent=d.alphaDesc;el('descBeta').textContent=d.betaDesc;el('descPc').textContent=d.oldDesc;el('descTouch').textContent=d.touchDesc;
  el('footerText').textContent=d.footer;langBtn.textContent='ğŸŒ '+d.lang;filterInput.placeholder=d.searchPH;document.documentElement.lang=l;
  el('secOmniTitle').textContent=d.secOmni; el('secOmniHint').textContent=d.secOmniHint;
  el('secNewTitle').textContent=d.secNew;   el('secNewHint').textContent=d.secNewHint;
  el('cueNewText').textContent=d.cueNew;
  /* ä¸‹æ®µ(æ–°ã‚·ãƒªãƒ¼ã‚º)ã®i18nè¦ç´ ã«ä¸€æ‹¬åæ˜  */
  document.querySelectorAll('#gridSoon [data-i18n]').forEach(el => { el.textContent = d[el.dataset.i18n] || el.textContent; });
  document.querySelectorAll('#gridSoon [data-i18n-mark]').forEach(el => { el.textContent = d[el.dataset.i18nMark] || el.textContent; });
}

/* ===== Clock HUD + Battery ===== */
let clockTimer=null; function pad(n){ return String(n).padStart(2,'0') }
function startClock(){
  if(clockTimer) clearInterval(clockTimer);
  const wjp=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'], wen=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'], wko=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '], wzhs=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'], wru=['Ğ’Ñ','ĞŸĞ½','Ğ’Ñ‚','Ğ¡Ñ€','Ğ§Ñ‚','ĞŸÑ‚','Ğ¡Ğ±'], wfr=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  const pickW=d=>({ja:wjp,ko:wko,zh:wzhs,ru:wru,fr:wfr}[lang]?.[d]||wen[d]);
  const monthShort=m=>({fr:['Janv','FÃ©vr','Mars','Avr','Mai','Juin','Juil','AoÃ»t','Sept','Oct','Nov','DÃ©c'],ru:['Ğ¯Ğ½Ğ²','Ğ¤ĞµĞ²','ĞœĞ°Ñ€','ĞĞ¿Ñ€','ĞœĞ°Ğ¹','Ğ˜ÑĞ½','Ğ˜ÑĞ»','ĞĞ²Ğ³','Ğ¡ĞµĞ½','ĞĞºÑ‚','ĞĞ¾Ñ','Ğ”ĞµĞº']}[lang]?.[m]||['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m]);
  const tick=()=>{const now=new Date();const hh=pad(now.getHours()),mm=pad(now.getMinutes()),ss=pad(now.getSeconds());const y=now.getFullYear(), m=now.getMonth()+1, d=now.getDate(); clockTime.textContent=`${hh}:${mm}:${ss}`;
    const w=pickW(now.getDay()); let dateText=''; if(lang==='ja'||lang==='zh'){dateText=`${y}å¹´${m}æœˆ${d}æ—¥ï¼ˆ${w}ï¼‰`;} else if(lang==='ko'){dateText=`${y}.${m}.${d} (${w})`;} else if(lang==='ru'){dateText=`${d} ${monthShort(m-1)} ${y} (${w})`;} else if(lang==='fr'){dateText=`${w} ${d} ${monthShort(m-1)} ${y}`;} else {dateText=`${w}, ${monthShort(m-1)} ${d}, ${y}`;} clockDate.textContent=dateText;
    const sec = now.getSeconds() + now.getMilliseconds()/1000; clockRing.style.setProperty('--sec', ((sec/60)*100).toFixed(2)+'%'); };
  tick(); clockTimer=setInterval(tick,150);
}
startClock();
/* Battery */
if(navigator.getBattery){ navigator.getBattery().then(b=>{const upd=()=>{clockBatt.textContent=Math.round(b.level*100)+'%'+(b.charging?'âš¡':'' ); clockBatt.hidden=false}; ['levelchange','chargingchange'].forEach(ev=>b.addEventListener(ev,upd)); upd(); }).catch(()=>{}); }

/* ===== Cursor & ripple ===== */
window.addEventListener('mousemove',(e)=>{cursor.style.transform=`translate(${e.clientX-170}px,${e.clientY-170}px)`});
document.addEventListener('click',(e)=>{const btn=e.target.closest('.btn');if(!btn)return;const r=btn.getBoundingClientRect();const span=document.createElement('span');span.className='ripple';span.style.left=(e.clientX-r.left)+'px';span.style.top=(e.clientY-r.top)+'px';btn.appendChild(span);setTimeout(()=>span.remove(),650)});

/* ===== Trail ===== */
let trailOn=false, trailPool=[];
function enableTrail(){ if(trailOn) return; trailOn=true; window.addEventListener('mousemove', trailTick) }
function disableTrail(){ if(!trailOn) return; trailOn=false; window.removeEventListener('mousemove', trailTick) }
function trailTick(e){ if(document.documentElement.classList.contains('reduce') || !settings.trail) return; const d=document.createElement('div'); d.className='trail'; d.style.left=e.clientX+'px'; d.style.top=e.clientY+'px'; document.body.appendChild(d); trailPool.push(d); if(trailPool.length>36){ const x=trailPool.shift(); x.remove() } setTimeout(()=>d.remove(),650); }

/* ===== Apply settings ===== */
function applySettings(){
  document.documentElement.classList.toggle('reduce', !!settings.reduce);
  optReduce && (optReduce.checked=!!settings.reduce);
  optAutoReduce && (optAutoReduce.checked=!!settings.autoReduce);
  optTilt   && (optTilt.checked=!!settings.tilt);
  optFocus  && (optFocus.checked=!!settings.focus);
  optConfetti && (optConfetti.checked=!!settings.confetti);
  optParticles && (optParticles.value=+settings.particles);
  optTheme  && (optTheme.value = store.get(themeKey,'dark'));
  optBeams  && (optBeams.checked=!!settings.beams);
  optStars  && (optStars.checked=!!settings.stars);
  optWarp   && (optWarp.checked =!!settings.warp);
  optScan   && (optScan.checked =!!settings.scan);
  optTrail  && (optTrail.checked=!!settings.trail);
  optSheen  && (optSheen.checked=!!settings.sheen);
  optMagnet && (optMagnet.checked=!!settings.magnet);
  optAutoCycle && (optAutoCycle.checked=!!settings.autoCycle);
  optFps    && (optFps.checked=!!settings.fps);
  optFavFirst && (optFavFirst.checked=!!settings.favFirst);
  optDragOrder && (optDragOrder.checked=!!settings.dragOrder);
  optAccentCycle && (optAccentCycle.checked=!!settings.accentCycle);
  /* æ–°è¦UIåæ˜  */
  optCompact && (optCompact.checked=!!settings.compact);
  optListView && (optListView.checked=!!settings.listView);
  optTitleShimmer && (optTitleShimmer.checked=!!settings.titleShimmer);
  optClock && (optClock.checked=!!settings.clock);

  const titleEl=document.querySelector('header h1');
  if(titleEl) titleEl.classList.toggle('shimmer', !!settings.titleShimmer);
  document.documentElement.classList.toggle('sheen-on', !!settings.sheen);
  document.body.classList.toggle('compact', !!settings.compact);
  document.body.classList.toggle('list', !!settings.listView);
  if(clockHud) clockHud.style.display = settings.clock ? '' : 'none';
  if(fpsBox) fpsBox.classList.toggle('show', !!settings.fps);

  if(settings.accentCycle) startAccentShift(); else stopAccentShift();
  applyFX();
}
applySettings();

/* ===== Particles ===== */
(function spawnParticles(){
  const prefersReduced = matchMedia?.('(prefers-reduced-motion: reduce)').matches;
  const N = (settings.reduce||prefersReduced) ? 0 : ( +settings.particles || (innerWidth > 1200 ? 90 : 48) );
  for(let i=0;i<N;i++){
    const p=document.createElement('div'); p.className='particle';
    p.style.setProperty('--x',Math.random()*100+'vw'); p.style.setProperty('--spd',(6+Math.random()*8)+'s'); p.style.setProperty('--z',(Math.random()*200-100)+'px');
    p.style.animationDelay=(Math.random()*10)+'s'; document.body.appendChild(p);
  }
})();

/* ===== Cards (ä¸Šæ®µã®ã¿) & favorites ===== */
const cards = Array.from(document.querySelectorAll('#grid .card')); // ä¸‹æ®µï¼ˆgridSoonï¼‰ã¯é™¤å¤–
let favs = new Set(store.get(favKey, []));
document.querySelectorAll('#grid .card .fav').forEach(btn=>{
  const card = btn.closest('.card'); const slug=card.dataset.slug;
  if(favs.has(slug)) btn.classList.add('on');
  btn.addEventListener('click',(e)=>{
    e.stopPropagation();
    if(favs.has(slug)){ favs.delete(slug); btn.classList.remove('on'); toast('ãŠæ°—ã«å…¥ã‚Šã‚’è§£é™¤'); }
    else{ favs.add(slug); btn.classList.add('on'); confetti(btn); toast('ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ '); }
    store.set(favKey, Array.from(favs));
    if(settings.favFirst) reorderFavs();
  });
});
function reorderFavs(){
  const list=[...grid.children];
  list.sort((a,b)=>{
    const A=favs.has(a.dataset.slug), B=favs.has(b.dataset.slug);
    if(A&&!B) return -1; if(!A&&B) return 1;
    return 0;
  }).forEach(node=>grid.appendChild(node));
}

/* ===== Drag & drop orderï¼ˆä¸Šæ®µã®ã¿ï¼‰ ===== */
let dragged=null;
function saveOrder(){ const arr=[...grid.children].map(n=>n.dataset.slug); store.set(orderKey, arr); }
function applyStoredOrder(){
  const order=store.get(orderKey,null); if(!order) return;
  const map={}; [...grid.children].forEach(n=>map[n.dataset.slug]=n);
  order.forEach(slug=>{ const n=map[slug]; if(n) grid.appendChild(n); });
}
function enableDrag(){
  grid.querySelectorAll('.card').forEach(c=>{
    c.setAttribute('draggable','true');
    c.addEventListener('dragstart',()=>{ c.style.opacity='.5'; });
    c.addEventListener('dragend',()=>{ c.style.opacity=''; saveOrder(); });
    c.addEventListener('dragover',e=>{ e.preventDefault(); if(!dragged||dragged===c) return; const rect=c.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; grid.insertBefore(dragged, before? c : c.nextSibling); });
    c.addEventListener('dragenter',()=>{ dragged=c; });
  });
}
function disableDrag(){ grid.querySelectorAll('.card').forEach(c=>c.removeAttribute('draggable')); }
if(settings.dragOrder) enableDrag(); else disableDrag();

/* Apply order then fav-first */
applyStoredOrder();
if(settings.favFirst) reorderFavs();

/* ===== 3D tilt / spotlightï¼ˆä¸Šæ®µã®ã¿ï¼‰ ===== */
cards.forEach((card)=>{
  card.addEventListener('mousemove',(e)=>{
    if(!settings.tilt) return;
    const r=card.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top; const midX=r.width/2, midY=r.height/2;
    card.style.setProperty('--rY',((x-midX)/midX)*10+'deg'); card.style.setProperty('--rX',((midY-y)/midY)*10+'deg');
    card.style.setProperty('--spot-x',(x/r.width*100)+'%'); card.style.setProperty('--spot-y',(y/r.height*100)+'%');
  });
  card.addEventListener('mouseleave',()=>{card.style.setProperty('--rY','0deg');card.style.setProperty('--rX','0deg')});
});

/* ===== Confetti ===== */
function confetti(anchor){
  if(!settings.confetti) return;
  const prefersReduced=matchMedia?.('(prefers-reduced-motion: reduce)').matches; if(prefersReduced) return;
  const r=anchor.getBoundingClientRect(); const N=16;
  for(let i=0;i<N;i++){
    const s=document.createElement('div'); const size=6+Math.random()*8;
    s.style.position='fixed'; s.style.left=(r.left+r.width/2)+'px'; s.style.top=(r.top+10)+'px';
    s.style.width=size+'px'; s.style.height=size+'px'; s.style.background=`hsl(${Math.random()*360},90%,60%)`;
    s.style.borderRadius='2px'; s.style.boxShadow='0 2px 8px rgba(0,0,0,.25)'; s.style.zIndex=30; s.style.pointerEvents='none';
    const vx=(Math.random()-0.5)*3, vy=-(2+Math.random()*2), rot=(Math.random()*360)+'deg'; const life=900+Math.random()*500;
    document.body.appendChild(s); const t0=performance.now();
    (function tick(now){ const dt=(now-t0)/1000; const x=vx*60*dt; const y=vy*60*dt+80*dt*dt;
      s.style.transform=`translate(${x}px,${y}px) rotate(${rot})`; s.style.opacity=String(1-dt/(life/1000));
      if(now-t0<life) requestAnimationFrame(tick); else s.remove();
    })(t0);
  }
}

/* ===== UI sound ===== */
let audioCtx=null, buffer=null, seLoaded=false;
async function initAudio(){ if(seLoaded) return; try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); const res=await fetch('Sound1.mp3',{cache:'no-store'}); const arr=await res.arrayBuffer(); buffer=await audioCtx.decodeAudioData(arr); seLoaded=true }catch(e){ seLoaded=false } }
window.addEventListener('click',()=>{ initAudio() },{once:true});
async function playSE(){ if(!audioCtx || !buffer) return; if(audioCtx.state==='suspended'){ try{ await audioCtx.resume() }catch{} } const src=audioCtx.createBufferSource(); src.buffer=buffer; src.connect(audioCtx.destination); src.start(0) }

/* ===== Focus / openï¼ˆä¸Šæ®µã®ã¿ï¼‰ ===== */
function openCard(card, newtab=false){
  const href=card.getAttribute('data-href')||card.querySelector('a.btn')?.href; if(!href) return;
  if(newtab) window.open(href,'_blank'); else location.href=href;
}
function focusCard(card){
  cards.forEach(c=>c.classList.remove('focused')); grid.classList.add('focus-mode'); card.classList.add('focused');
  if(nebulaEl){ nebulaEl.classList.add('flare'); setTimeout(()=>nebulaEl.classList.remove('flare'),800); }
  confetti(card); playSE(); if(navigator.vibrate) navigator.vibrate([8,30,8]);
  store.set('om.last', card.dataset.slug||''); history.replaceState(null,'', '#'+(card.dataset.slug||''));
}
cards.forEach((card)=>{
  card.addEventListener('click',()=>{ if(!settings.focus){ openCard(card); return } const was=card.classList.contains('focused'); if(!was) focusCard(card); else grid.classList.remove('focus-mode'); });
  let touchTimer=null; card.addEventListener('touchstart',()=>{ touchTimer=setTimeout(()=>focusCard(card),400) },{passive:true});
  card.addEventListener('touchend',()=>{ clearTimeout(touchTimer) });
});

/* ===== Outside clickï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰é™¤å¤–ï¼‰ ===== */
document.addEventListener('click',(e)=>{ if(!e.target.closest('#grid .card') && !e.target.closest('#settingsBtn') && !e.target.closest('#settingsModal') && !e.target.closest('#helpModal')){ grid.classList.remove('focus-mode'); cards.forEach(c=>c.classList.remove('focused')) }});

/* ===== Keys ===== */
document.addEventListener('keydown',(e)=>{
  const isTyping = /^(input|textarea)$/i.test(e.target.tagName) || e.target.isContentEditable;
  const idx = document.activeElement && document.activeElement.classList.contains('card') ? cards.indexOf(document.activeElement) : -1;
  if((e.key==='k' && (e.ctrlKey||e.metaKey)) || e.key==='/'){ e.preventDefault(); filterInput?.focus(); filterInput?.select(); return }
  if(e.key==='?'){ e.preventDefault(); helpModal?.classList.add('show'); return }
  if(e.key==='ArrowRight'){ e.preventDefault(); cards[(idx+1+cards.length)%cards.length]?.focus() }
  if(e.key==='ArrowLeft'){ e.preventDefault(); cards[(idx-1+cards.length)%cards.length]?.focus() }
  if(e.key==='Enter'){ if(idx>=0){ const card=cards[idx]; if(card.classList.contains('focused')) openCard(card); else focusCard(card) } }
  if(e.key==='o'){ if(idx>=0){ const card=cards[idx]; openCard(card) } }
  if(e.key==='Escape'){ grid.classList.remove('focus-mode'); cards.forEach(c=>c.classList.remove('focused')); settingsModal?.classList.remove('show'); helpModal?.classList.remove('show') }
  if(/^[1-4]$/.test(e.key)){ const n=+e.key-1; cards[n]?.focus(); if(!settings.focus) openCard(cards[n]); }
  /* è¿½åŠ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ */
  if(!isTyping && e.key.toLowerCase()==='x'){ fxMuted=!fxMuted; applyFX(); toast(fxMuted?'FXã‚’ãƒŸãƒ¥ãƒ¼ãƒˆ':'FXã‚’å†é–‹'); }
  if(!isTyping && e.key.toLowerCase()==='l'){ settings.listView=!settings.listView; store.set(settingsKey,settings); applySettings(); toast(settings.listView?'ãƒªã‚¹ãƒˆè¡¨ç¤º':'ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º'); }
  if(!isTyping && e.key.toLowerCase()==='c'){ settings.compact=!settings.compact; store.set(settingsKey,settings); applySettings(); toast(settings.compact?'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º':'æ¨™æº–è¡¨ç¤º'); }
});

/* ===== Filter + highlightï¼ˆä¸Šæ®µã®ã¿ï¼‰ ===== */
function clearMarks(el){ el.querySelectorAll('mark').forEach(m=>{const t=document.createTextNode(m.textContent); m.replaceWith(t)}) }
function highlight(el, q){ if(!q){ clearMarks(el); return } clearMarks(el); const walk=(node)=>{ if(node.nodeType===3){ const i=node.nodeValue.toLowerCase().indexOf(q); if(i>-1){ const span=document.createElement('mark'); const r=node.splitText(i); r.splitText(q.length); span.textContent=r.nodeValue; r.replaceWith(span) } } else if(node.nodeType===1){ node.childNodes.forEach(walk) } }; ['h2','p'].forEach(sel=>{ el.querySelectorAll(sel).forEach(walk) }); }
function applyFilter(){ const q=(filterInput.value||'').trim().toLowerCase(); cards.forEach(card=>{ const text = card.innerText.toLowerCase() + ' ' + (card.dataset.tags||'').toLowerCase() + (favs.has(card.dataset.slug)?' fav favorite':''); card.style.display = text.includes(q) ? '' : 'none'; highlight(card, q); }); }
filterInput?.addEventListener('input', applyFilter);

/* ===== Section scroll cue ===== */
scrollToNew?.addEventListener('click',()=>{ document.getElementById('series-new')?.scrollIntoView({behavior:'smooth', block:'start'}) });

/* ===== Settings modal wiring ===== */
settingsBtn?.addEventListener('click',()=>{ settingsModal?.classList.add('show') });
settingsModal?.addEventListener('click',(e)=>{ if(e.target===settingsModal) settingsModal.classList.remove('show') });
document.getElementById('optClose')?.addEventListener('click',()=>settingsModal?.classList.remove('show'));
optReduce?.addEventListener('change',()=>{ settings.reduce=optReduce.checked; store.set(settingsKey,settings); applySettings(); location.reload() });
optAutoReduce?.addEventListener('change',()=>{ settings.autoReduce=optAutoReduce.checked; store.set(settingsKey,settings) });
optTilt?.addEventListener('change',()=>{ settings.tilt=optTilt.checked; store.set(settingsKey,settings) });
optFocus?.addEventListener('change',()=>{ settings.focus=optFocus.checked; store.set(settingsKey,settings) });
optConfetti?.addEventListener('change',()=>{ settings.confetti=optConfetti.checked; store.set(settingsKey,settings) });
optParticles?.addEventListener('input',()=>{ settings.particles=+optParticles.value; store.set(settingsKey,settings) });
optFps?.addEventListener('change',()=>{ settings.fps=optFps.checked; store.set(settingsKey,settings); fpsBox?.classList.toggle('show', !!settings.fps) });
optFavFirst?.addEventListener('change',()=>{ settings.favFirst=optFavFirst.checked; store.set(settingsKey,settings); if(settings.favFirst) reorderFavs(); else applyStoredOrder(); });
optDragOrder?.addEventListener('change',()=>{ settings.dragOrder=optDragOrder.checked; store.set(settingsKey,settings); settings.dragOrder? enableDrag(): disableDrag() });

;['optBeams','optStars','optWarp','optScan','optTrail','optSheen','optMagnet','optAutoCycle'].forEach(id=>{
  const _el=document.getElementById(id); _el?.addEventListener('change',()=>{
    settings.beams=document.getElementById('optBeams')?.checked ?? settings.beams;
    settings.stars=document.getElementById('optStars')?.checked ?? settings.stars;
    settings.warp =document.getElementById('optWarp')?.checked  ?? settings.warp;
    settings.scan =document.getElementById('optScan')?.checked  ?? settings.scan;
    settings.trail=document.getElementById('optTrail')?.checked ?? settings.trail;
    settings.sheen=document.getElementById('optSheen')?.checked ?? settings.sheen;
    settings.magnet=document.getElementById('optMagnet')?.checked?? settings.magnet;
    settings.autoCycle=document.getElementById('optAutoCycle')?.checked ?? settings.autoCycle;
    store.set(settingsKey,settings);
    document.documentElement.classList.toggle('sheen-on', !!settings.sheen);
    applyFX(); bindMagnet();
  })
});

/* æ–°è¦è¨­å®šã‚¤ãƒ™ãƒ³ãƒˆ */
optCompact?.addEventListener('change',()=>{ settings.compact=optCompact.checked; store.set(settingsKey,settings); applySettings(); });
optListView?.addEventListener('change',()=>{ settings.listView=optListView.checked; store.set(settingsKey,settings); applySettings(); });
optTitleShimmer?.addEventListener('change',()=>{ settings.titleShimmer=optTitleShimmer.checked; store.set(settingsKey,settings); applySettings(); });
optClock?.addEventListener('change',()=>{ settings.clock=optClock.checked; store.set(settingsKey,settings); applySettings(); });

optAccent?.addEventListener('input',()=>{ accent=optAccent.value; store.set(accentKey,accent); if(!settings.accentCycle) applyAccent(accent) });
optAccentRand?.addEventListener('click',()=>{ const rand = '#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0'); accent = rand; store.set(accentKey,accent); if(!settings.accentCycle) applyAccent(accent); });
optAccentCycle?.addEventListener('change',()=>{ settings.accentCycle=optAccentCycle.checked; store.set(settingsKey,settings); settings.accentCycle? startAccentShift(): stopAccentShift(); });

/* Export/Import/Reset */
optExport?.addEventListener('click',()=>{
  const blob = new Blob([JSON.stringify({settings:settings, accent:accent, theme:store.get(themeKey), order:store.get(orderKey)}, null, 2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='omni_settings.json'; a.click(); URL.revokeObjectURL(a.href);
  toast('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
});
optImport?.addEventListener('change',(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const fr=new FileReader(); fr.onload=()=>{
    try{
      const data=JSON.parse(fr.result);
      if(data.theme) store.set(themeKey, data.theme);
      if(data.accent){ accent=data.accent; store.set(accentKey, accent) }
      if(data.settings){ Object.assign(settings, data.settings); store.set(settingsKey, settings) }
      if(data.order) store.set(orderKey, data.order);
      applyAccent(accent); applyTheme(store.get(themeKey,'dark')); applySettings(); applyStoredOrder(); if(settings.favFirst) reorderFavs();
      toast('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã§åæ˜ ãŒå®‰å®šã—ã¾ã™', {action:'å†èª­ã¿è¾¼ã¿', onAction:()=>location.reload()});
    }catch{ toast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', {type:'error'}) }
  };
  fr.readAsText(f);
});
optReset?.addEventListener('click',()=>{ localStorage.removeItem(settingsKey); localStorage.removeItem(accentKey); localStorage.removeItem(themeKey); localStorage.removeItem(orderKey); toast('è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', {action:'å†èª­ã¿è¾¼ã¿', onAction:()=>location.reload()}); });
optResetOrder?.addEventListener('click',()=>{ localStorage.removeItem(orderKey); toast('é †åºã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', {action:'å†èª­ã¿è¾¼ã¿', onAction:()=>location.reload()}); });

/* ===== Splash boot with progress ===== */
(function(){
  const bar = document.getElementById('sProgress')?.querySelector('.bar');
  const setP = (n)=>{ if(bar) bar.style.setProperty('--p', Math.max(0, Math.min(100, n)) + '%') };
  let p = 6; setP(p); const t0 = performance.now(); const MIN_SHOW = 800; const MAX_WAIT = 2600;
  const step = (delta)=>{ p = Math.min(100, p + delta); setP(p) };
  const fReady = (document.fonts?.ready || Promise.resolve()).then(()=>step(35));
  const idle = new Promise(r => (window.requestIdleCallback ? requestIdleCallback(()=>r(), {timeout:900}) : setTimeout(r, 500))).then(()=>step(30));
  window.addEventListener('load', ()=> step(25), { once:true });
  function closeSplash(){ const elapsed = performance.now() - t0; const wait = Math.max(0, MIN_SHOW - elapsed);
    setTimeout(()=>{ document.body.classList.add('loaded'); splash.classList.add('hide'); setTimeout(()=> splash.remove(), 800); }, wait); }
  Promise.race([ Promise.allSettled([fReady, idle]).then(()=>true), new Promise(r=>setTimeout(()=>r(true), MAX_WAIT)) ]).then(closeSplash);
  const reduced = document.documentElement.classList.contains('reduce') || (matchMedia?.('(prefers-reduced-motion: reduce)').matches);
  if (reduced) { setTimeout(()=>{ setP(100) }, 200); }
})();

/* ===== Context menuï¼ˆä¸Šæ®µã®ã¿ï¼‰ ===== */
let ctxTarget=null;
document.addEventListener('contextmenu',(e)=>{
  const card=e.target.closest('.card');
  if(!card || !card.closest('#grid') || card.classList.contains('soon')) return;
  e.preventDefault(); ctxTarget=card; ctxMenu.style.display='block';
  const w=ctxMenu.offsetWidth, h=ctxMenu.offsetHeight;
  const x=Math.min(innerWidth-w-8, Math.max(8, e.clientX));
  const y=Math.min(innerHeight-h-8, Math.max(8, e.clientY));
  ctxMenu.style.left=x+'px'; ctxMenu.style.top=y+'px';
},{passive:false});
document.addEventListener('click',(e)=>{ if(e.target.closest('#ctx .row')) return; ctxMenu.style.display='none' });
ctxMenu.addEventListener('click',(e)=>{
  const cmd=e.target.dataset.cmd; if(!cmd||!ctxTarget) return;
  const href=ctxTarget.getAttribute('data-href')||ctxTarget.querySelector('a.btn')?.href;
  if(cmd==='open') openCard(ctxTarget);
  if(cmd==='newtab') openCard(ctxTarget,true);
  if(cmd==='copy' && href){ navigator.clipboard?.writeText(href).then(()=>{ e.target.textContent='ã‚³ãƒ”ãƒ¼æ¸ˆã¿'; setTimeout(()=>e.target.textContent='ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼',900) }) }
  if(cmd==='fav'){ const slug=ctxTarget.dataset.slug; const btn=ctxTarget.querySelector('.fav'); btn?.click(); toast(favs.has(slug)?'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ':'ãŠæ°—ã«å…¥ã‚Šã‚’è§£é™¤') }
  ctxMenu.style.display='none';
});

/* ===== PWA ===== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.style.display='inline-flex' });
installBtn?.addEventListener('click',async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); try{ await deferredPrompt.userChoice }catch{} deferredPrompt=null; if(installBtn) installBtn.style.display='none' });

/* ===== Share (file:// safe) ===== */
shareBtn?.addEventListener('click', async ()=>{
  const slug = (document.querySelector('#grid .card.focused')?.dataset.slug)||'';
  const base = (location.origin && location.origin !== 'null') ? (location.origin + location.pathname) : location.href.replace(location.hash,'');
  const shareUrl = slug ? (base + '#' + slug) : base;
  const data={ title:document.title, text:'OmniMedia â€“ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°', url:shareUrl };
  if(navigator.share){ try{ await navigator.share(data) }catch{} }
  else if(navigator.clipboard){ try{ await navigator.clipboard.writeText(shareUrl); shareBtn.textContent='ã‚³ãƒ”ãƒ¼æ¸ˆã¿'; setTimeout(()=>shareBtn.textContent='å…±æœ‰',1200) }catch{} }
});

/* ===== Deep linkï¼ˆä¸Šæ®µã®ã¿ï¼‰ ===== */
function cardBySlug(slug){ return cards.find(c=> (c.dataset.slug||'')===slug) }
function bootRoute(){
  const url=new URL(location.href);
  const open=url.searchParams.get('open');
  const hash=(location.hash||'').replace(/^#/,'');
  const fx=url.searchParams.get('fx'); if(fx==='off'){ fxMuted=true; applyFX(); toast('FXã‚’ãƒŸãƒ¥ãƒ¼ãƒˆã—ã¦èµ·å‹•ä¸­'); }
  if(open){ const c=cardBySlug(open); if(c) { openCard(c); return } }
  if(hash){ const c=cardBySlug(hash); if(c){ focusCard(c); c.focus(); return } }
  const last=store.get('om.last',''); if(last){ const c=cardBySlug(last); if(c){ c.focus() } }
}
bootRoute();

/* ===== SW update notice ===== */
if('serviceWorker' in navigator && (location.protocol==='https:'||location.hostname==='localhost')){
  navigator.serviceWorker.register('./sw.js').then(reg=>{
    if(reg.waiting){ toast('æ›´æ–°ãŒã‚ã‚Šã¾ã™',{action:'å†èª­ã¿è¾¼ã¿', onAction:()=>location.reload()}) }
    reg.addEventListener('updatefound',()=>{
      const sw=reg.installing; if(sw){ sw.addEventListener('statechange',()=>{ if(sw.state==='installed' && navigator.serviceWorker.controller){ toast('æ›´æ–°ãŒé©ç”¨å¯èƒ½ã§ã™',{action:'å†èª­ã¿è¾¼ã¿', onAction:()=>location.reload()}) } }) }
    });
  }).catch(()=>{});
}

/* ===== Visibility ===== */
document.addEventListener('visibilitychange',()=>{ if(document.hidden) document.documentElement.classList.add('reduce'); else document.documentElement.classList.toggle('reduce', !!settings.reduce); });

/* ===== Parallax ===== */
(function(){
  let raf=0, tx=0, ty=0, dx=0, dy=0;
  window.addEventListener('mousemove',(e)=>{ const cx=innerWidth/2, cy=innerHeight/2; dx=(e.clientX-cx)/cx; dy=(e.clientY-cy)/cy; if(!raf) raf=requestAnimationFrame(loop); });
  function loop(){ tx += (dx-tx)*0.08; ty += (dy-ty)*0.08; const t1=`translate(${tx*10}px,${ty*10}px)`, t2=`translate(${tx*18}px,${ty*14}px)`, t3=`translate(${tx*12}px,${ty*12}px)`; bgEl.style.transform=t1; auroraEl.style.transform=t2; nebulaEl.style.transform=t3; if(Math.abs(dx-tx)<0.001 && Math.abs(dy-ty)<0.001){ cancelAnimationFrame(raf); raf=0 } else { raf=requestAnimationFrame(loop) } }
})();

/* ===== Magnet buttons ===== */
let magnetOn=false, btns=[];
function bindMagnet(){ btns = Array.from(document.querySelectorAll('.btn')); if(settings.magnet && !magnetOn){ window.addEventListener('mousemove',magnetMove); magnetOn=true } if(!settings.magnet && magnetOn){ window.removeEventListener('mousemove',magnetMove); magnetOn=false; btns.forEach(b=>{ b.style.setProperty('--mx','0px'); b.style.setProperty('--my','0px'); b.style.setProperty('--ms','1') }) } }
bindMagnet();
function magnetMove(e){ if(document.documentElement.classList.contains('reduce')) return; btns.forEach(b=>{ const r=b.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; const dx=e.clientX-cx, dy=e.clientY-cy; const dist=Math.hypot(dx,dy); const influence = Math.max(0, 1 - Math.min(dist,240)/240); const mx= (dx*0.08*influence).toFixed(2)+'px'; const my= (dy*0.08*influence).toFixed(2)+'px'; b.style.setProperty('--mx', mx); b.style.setProperty('--my', my); }); }

/* ===== FX apply with mute flag & auto reduce ===== */
function applyFX(){
  const reduced = document.documentElement.classList.contains('reduce') || matchMedia?.('(prefers-reduced-motion: reduce)').matches;
  const block = reduced || fxMuted;
  beams?.classList.toggle('show', !!settings.beams && !block);
  stars?.classList.toggle('show', !!settings.stars && !block);
  warp ?.classList.toggle('show', !!settings.warp  && !block);
  scan ?.classList.toggle('show', !!settings.scan  && !block);
  if(settings.trail && !reduced && !fxMuted) enableTrail(); else disableTrail();
}
applyFX();

/* ===== FPS + auto reduce ===== */
(function(){
  let last=performance.now(), frames=0, acc=0, lowAcc=0;
  function tick(now){
    const dt=now-last; last=now; frames++; acc+=dt; lowAcc+=dt;
    if(acc>=500){ const fps=Math.round(frames/(acc/1000)); if(settings.fps && fpsBox){ fpsBox.textContent='fps: '+fps+(fxMuted?' (auto-low)':'') } frames=0; acc=0 }
    if(settings.autoReduce){
      if(lowAcc>=1000){ const fpsEst = Math.round(frames/(lowAcc/1000));
        if(fpsEst<30){ if(!fxMuted){ fxMuted=true; applyFX(); netBadge.textContent='AutoLow'; netBadge.classList.add('off'); toast('è‡ªå‹•ç¯€é›»ï¼šFXã‚’ä¸€æ™‚ãƒŸãƒ¥ãƒ¼ãƒˆä¸­') } }
        else if(fpsEst>45){ if(fxMuted){ fxMuted=false; applyFX(); updateNetBadge(); toast('FXã‚’å†é–‹ã—ã¾ã—ãŸ') } }
        lowAcc=0; frames=0;
      }
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();

/* ===== Network badge ===== */
function updateNetBadge(){ const on = navigator.onLine; netBadge.textContent = on?'Online':'Offline'; netBadge.classList.toggle('off', !on); }
window.addEventListener('online', ()=>{ updateNetBadge(); toast('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ') });
window.addEventListener('offline',()=>{ updateNetBadge(); toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™', {type:'error'}) });
updateNetBadge();

/* ===== Help ===== */
helpBtn?.addEventListener('click',()=>helpModal?.classList.add('show'));
helpModal?.addEventListener('click',(e)=>{ if(e.target===helpModal) helpModal.classList.remove('show') });
document.getElementById('helpClose')?.addEventListener('click',()=>helpModal?.classList.remove('show'));

/* ===== Toast ===== */
function toast(msg, opt={}){ const box=document.getElementById('toasts'); if(!box) return; const t=document.createElement('div'); t.className='toast'; if(opt.type==='error') t.style.borderLeftColor='var(--err)'; t.textContent=msg; if(opt.action){ const a=document.createElement('span'); a.className='act'; a.textContent=' '+opt.action; a.addEventListener('click',()=>{ opt.onAction?.(); t.remove() }); t.appendChild(a) } box.appendChild(t); setTimeout(()=>t.remove(), 4000); }

/* ===== Low spec propose (first run) ===== */
(function(){ const flagKey='om.lowspec.prompted'; if(store.get(flagKey,false)) return; const hc=navigator.hardwareConcurrency||8, mem=navigator.deviceMemory||8; if(hc<=4 || mem<=4){ toast('ä½ã‚¹ãƒšãƒƒã‚¯ç’°å¢ƒã‚’æ¤œå‡ºã€‚çœã‚¨ãƒãƒ¢ãƒ¼ãƒ‰ã‚’æ¨å¥¨ã—ã¾ã™',{action:'æœ‰åŠ¹åŒ–', onAction:()=>{ settings.reduce=true; store.set(settingsKey,settings); applySettings(); location.reload() }}); } store.set(flagKey,true); })();

/* ===== Konami ===== */
(function(){ const seq=['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a']; let i=0; window.addEventListener('keydown',(e)=>{ i = (e.key===seq[i]) ? i+1 : (e.key===seq[0]?1:0); if(i===seq.length){ i=0; for(let k=0;k<8;k++) setTimeout(()=>confetti(document.querySelector('.brand')), k*120); toast('ğŸ‰ Secret!') } }); })();

/* ===== Settings UI (tabs / search / presets) ===== */
(function initSettingsUI(){
  const modal = document.getElementById('settingsModal'); if(!modal) return;
  const tabs = Array.from(modal.querySelectorAll('.tabs .tab'));
  const panels = Array.from(modal.querySelectorAll('.panel'));
  const key = 'om.ui.settingsTab';
  function activate(name){ tabs.forEach(b=> b.setAttribute('aria-selected', String(b.dataset.tab===name))); panels.forEach(p=> p.classList.toggle('active', p.dataset.panel===name)); try{ localStorage.setItem(key, JSON.stringify(name)) }catch{} }
  tabs.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.tab)));
  let lastTab='display'; try{ lastTab=JSON.parse(localStorage.getItem(key))||'display' }catch{}; activate(panels.some(p=>p.dataset.panel===lastTab)?lastTab:'display');

  document.getElementById('settingsBtn')?.addEventListener('click', ()=>{ setTimeout(()=> document.getElementById('settingsSearch')?.focus(), 50); });

  const q = document.getElementById('settingsSearch'); const filter=()=>{ const s=(q.value||'').trim().toLowerCase(); panels.forEach(panel=>{ panel.querySelectorAll('.opt').forEach(opt=>{ const text=opt.innerText.toLowerCase(); opt.style.display = s ? (text.includes(s)?'':'none') : ''; }); }); };
  q?.addEventListener('input', filter);

  const apply=()=>{ try{ localStorage.setItem(settingsKey, JSON.stringify(settings)) }catch{}; applySettings(); if(settings.favFirst) reorderFavs(); else applyStoredOrder(); applyFX?.(); bindMagnet?.(); };
  document.getElementById('presetBalanced')?.addEventListener('click',()=>{ Object.assign(settings,{ reduce:false, autoReduce:true, tilt:true, focus:true, confetti:true, beams:true, stars:true, warp:false, scan:false, trail:true, sheen:true, magnet:true, particles:(innerWidth>1200?72:42), fps:false, dragOrder:true, accentCycle:false, compact:false, listView:false, titleShimmer:true, clock:true, autoCycle:false }); apply(); });
  document.getElementById('presetPerformance')?.addEventListener('click',()=>{ Object.assign(settings,{ reduce:true, autoReduce:true, tilt:false, focus:false, confetti:false, beams:false, stars:false, warp:false, scan:false, trail:false, sheen:false, magnet:false, particles:0, fps:false, dragOrder:false, accentCycle:false, compact:true, listView:true, titleShimmer:false, clock:true, autoCycle:false }); apply(); });
  document.getElementById('presetAesthetic')?.addEventListener('click',()=>{ Object.assign(settings,{ reduce:false, autoReduce:false, tilt:true, focus:true, confetti:true, beams:true, stars:true, warp:true, scan:true, trail:true, sheen:true, magnet:true, particles:(innerWidth>1200?100:72), fps:false, dragOrder:true, accentCycle:true, compact:false, listView:false, titleShimmer:true, clock:true, autoCycle:true }); apply(); });
})();

/* ===== Idle screensaver + auto focus cycleï¼ˆä¸Šæ®µã®ã¿ï¼‰ ===== */
let idleTimer=null; const IDLE_MS=45000;
let cycleTimer=null, cycleIdx=0;
function startCycle(){ if(cycleTimer||!settings.autoCycle) return; const visCards=[...cards].filter(c=>c.style.display!=='none'); if(visCards.length===0) return; cycleIdx = Math.max(0, visCards.findIndex(c=>c.classList.contains('focused'))); cycleTimer=setInterval(()=>{ if(!settings.focus) return; cycleIdx=(cycleIdx+1)%visCards.length; focusCard(visCards[cycleIdx]); }, 5000); }
function stopCycle(){ if(!cycleTimer) return; clearInterval(cycleTimer); cycleTimer=null }
function setIdle(on){ document.body.classList.toggle('idle', on); if(on){ startCycle() } else { stopCycle() } }
function resetIdle(){ setIdle(false); clearTimeout(idleTimer); idleTimer=setTimeout(()=>setIdle(true), IDLE_MS); }
['mousemove','keydown','click','scroll','touchstart'].forEach(ev=>window.addEventListener(ev, resetIdle, {passive:true}));
resetIdle();

/* ===== Final init ===== */
window.addEventListener('load',()=>{ document.body.classList.add('loaded') });
</script>
</body>
</html>
